<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - FocusHub</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Technical Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <img id="dashboardLogo" src="FocusHub_vertnorm.svg" alt="FocusHub" class="status-logo" style="height: 80px; width: auto;">
        </div>
        <div class="status-middle">
            <div id="dashboardTimer" class="dashboard-timer hidden">
                <span class="timer-icon">‚è±</span>
                <span id="dashboardTimerText">00:00</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span class="status-text">SYSTEM STATUS: ONLINE</span>
            </div>
            <div class="status-time" id="currentTime"></div>
            <a href="admin.html" id="adminLink" class="btn-home hidden" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--primary-color); font-weight: 600; font-size: 0.875rem; text-decoration: none;">Admin</a>
            <button id="logoutBtn" class="btn-home" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem;">Logout</button>
        </div>
    </div>

    <!-- Admin Impersonation Banner -->
    <div id="impersonationBanner" class="impersonation-banner hidden">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <span>üëÅÔ∏è <strong>Viewing as:</strong> <span id="impersonatedEmail"></span></span>
            <button onclick="returnToAdmin()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Return to Admin</button>
        </div>
    </div>

    <!-- Mission Control Dashboard -->
    <div class="mission-control">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 class="mission-title" data-label="missionControl">MISSION CONTROL</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="mode-indicator" style="font-family: 'Courier New', monospace; font-size: 0.875rem; color: var(--text-secondary); padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px;">
                    MODE: <span id="currentMode" style="color: var(--text-primary); font-weight: 600;">LOADING...</span>
                </div>
                    <button onclick="window.WeeklyReports?.showReport()" class="btn btn-secondary" style="font-size: 0.875rem;">üìä Report</button>
                    <a href="upgrade.html" id="upgradeBtn" class="btn btn-primary hidden" style="font-size: 0.875rem;">‚ú® Upgrade</a>
                </div>
            
            <!-- Bento Grid -->
            <div class="bento-grid">
                <!-- Total Sprints -->
                <div class="bento-card activity-flow">
                    <div class="card-micro-label">LIVE_TICKER_01</div>
                    <h3 class="card-title">Activity Flow</h3>
                    <div class="activity-chart">
                        <div class="metric-large" id="totalSprints">0</div>
                        <div class="metric-label">Total Sprints</div>
                    </div>
                    <div class="activity-context">
                        Total: <span id="totalSprintsContext">0</span> <span class="trend-up">(‚Üë Last 7 days)</span>
                    </div>
                </div>

                <!-- Day Streak -->
                <div class="bento-card consistency-log">
                    <div class="card-micro-label">STREAK_TRACKER</div>
                    <h3 class="card-title">Consistency Log</h3>
                    <div class="consistency-chart">
                        <div class="metric-large" id="dayStreak">0</div>
                        <div class="metric-label">Day Streak (B+ or Higher)</div>
                    </div>
                    <div class="bar-chart-mini" id="weeklyChart"></div>
                </div>

                <!-- Focus Score -->
                <div class="bento-card daily-score">
                    <div class="card-micro-label">PERF_INDEX</div>
                    <h3 class="card-title">Performance Index</h3>
                    <div class="score-gauge">
                        <div class="gauge-value" id="focusScore">0%</div>
                        <div class="gauge-label">Avg Grade: <span id="avgGrade">N/A</span></div>
                    </div>
                    <div class="score-context">
                        Tasks Completed: <span class="streak-value" id="totalTasks">0</span>
                    </div>
                </div>

                <!-- NEW: Intention vs. Reality -->
                <div class="bento-card intention-reality">
                    <div class="card-micro-label">BEHAVIOR_DELTA</div>
                    <h3 class="card-title">Intention vs. Reality</h3>
                    <div class="intention-visual">
                        <div class="intention-bar">
                            <div class="intention-fill" id="intentionFill" style="width: 0%"></div>
                            <div class="intention-label">What You Said</div>
                        </div>
                        <div class="reality-bar">
                            <div class="reality-fill" id="realityFill" style="width: 0%"></div>
                            <div class="reality-label">What You Did</div>
                        </div>
                    </div>
                    <div class="intention-stats">
                        <div class="stat-item">
                            <span class="stat-num" id="intentionCount">0</span>
                            <span class="stat-desc">Declared Intentions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num" id="realityCount">0</span>
                            <span class="stat-desc">Followed Through</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Action -->
            <button class="primary-action" onclick="window.location.href='app.html'">
                <span class="action-icon">[ &gt; ]</span>
                <span class="action-text">INITIALIZE NEW SESSION</span>
            </button>

            <!-- Quick Stats Table -->
            <div class="stats-table">
                <h3 class="stats-title">SYSTEM METRICS</h3>
                <table>
                    <tr>
                        <td class="stat-label">Days Logged</td>
                        <td class="stat-value" id="daysLogged">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Average Distractions/Day</td>
                        <td class="stat-value" id="avgDistractions">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Sprint Completion Rate</td>
                        <td class="stat-value" id="sprintRate">0%</td>
                    </tr>
                </table>
            </div>
            
            <!-- Subject Breakdown (Student Mode Only) -->
            <div id="subjectBreakdownSection" class="stats-table hidden" style="margin-top: 2rem;">
                <h3 class="stats-title">üìö SUBJECT BREAKDOWN</h3>
                <div id="subjectBreakdown" class="subject-breakdown-content">
                    <!-- Populated by JavaScript -->
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-top: 1rem;">
                    Based on completed tasks
                </p>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="app.html">üéØ Workspace</a>
        <span class="footer-separator">|</span>
        <a href="how-to.html">üìñ How-to</a>
        <span class="footer-separator">|</span>
        <a href="faq.html">üí¨ Support</a>
    </footer>

    <!-- Mode Configuration System -->
    <script src="config.js"></script>
    
    <!-- Weekly Reports -->
    <script src="weekly-reports.js"></script>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJeuBD1TSL6gIZnr5sAKvTFYMj66ztzno",
            authDomain: "focushub-91094.firebaseapp.com",
            projectId: "focushub-91094",
            storageBucket: "focushub-91094.firebasestorage.app",
            messagingSenderId: "548003574834",
            appId: "1:548003574834:web:b19ed9ac4d4d84517bb82b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Check authentication and load user data
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
            } else {
                window.currentFirebaseUser = user;
                window.firebaseDb = db;
                
                // Load user profile
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid, 'profile', 'settings'));
                    if (userDoc.exists()) {
                        window.currentUserProfile = userDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
                
                initDashboard();
            }
        });
        
        // Logout function
        window.handleFirebaseLogout = async function() {
            if (confirm('Logout from dashboard?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        };
        
        function initDashboard() {
            // Dashboard initialization continues below
        }
    </script>

    <script>
        // ============================================
        // AUTHENTICATION CHECK (LEGACY - FIREBASE ABOVE)
        // ============================================
        const currentUser = JSON.parse(localStorage.getItem('focushub_current_user') || 'null');
        
        if (!currentUser) {
            // Not logged in, redirect to auth
            window.location.href = 'auth.html';
        }
        
        // ============================================
        // USER-SPECIFIC STORAGE HELPERS
        // ============================================
        function getUserKey(baseKey) {
            return currentUser ? `${baseKey}_${currentUser.id}` : baseKey;
        }
        
        function getUserItem(baseKey) {
            return localStorage.getItem(getUserKey(baseKey));
        }
        
        function setUserItem(baseKey, value) {
            localStorage.setItem(getUserKey(baseKey), value);
        }
        
        // Display current mode
        function displayCurrentMode() {
            const modeEl = document.getElementById('currentMode');
            if (modeEl && window.getModeDisplayName) {
                modeEl.textContent = getModeDisplayName().toUpperCase();
            }
            
            // Show admin link if user is admin
            const users = JSON.parse(localStorage.getItem('focushub_users') || '[]');
            const userFull = users.find(u => u.id === currentUser.id);
            if (userFull && userFull.plan === 'admin') {
                document.getElementById('adminLink').classList.remove('hidden');
            }
            
            // Show upgrade button if user is on free plan
            if (userFull && userFull.plan === 'free') {
                document.getElementById('upgradeBtn').classList.remove('hidden');
            }
            
            // Check for admin impersonation
            const adminReturn = sessionStorage.getItem('admin_return');
            if (adminReturn) {
                document.getElementById('impersonationBanner').classList.remove('hidden');
                document.getElementById('impersonatedEmail').textContent = currentUser.email;
            }
        }
        
        // Return to admin panel
        function returnToAdmin() {
            const adminReturn = sessionStorage.getItem('admin_return');
            if (!adminReturn) return;
            
            const adminUser = JSON.parse(adminReturn);
            
            // Restore admin session
            localStorage.setItem('focushub_current_user', JSON.stringify(adminUser));
            localStorage.setItem('focushub_mode', adminUser.mode);
            
            // Clear impersonation
            sessionStorage.removeItem('admin_return');
            
            // Return to admin panel
            window.location.href = 'admin.html';
        }
        
        // Update current time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toUTCString();
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Display mode on load
        displayCurrentMode();

        // Load stats from history
        function loadStats() {
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            
            if (history.length === 0) {
                return;
            }

            // Calculate total sprints
            const totalSprints = history.reduce((sum, day) => sum + day.sprintCount, 0);
            document.getElementById('totalSprints').textContent = totalSprints;
            document.getElementById('totalSprintsContext').textContent = totalSprints;

            // Calculate total tasks
            const totalTasks = history.reduce((sum, day) => sum + day.tasksCompleted, 0);
            document.getElementById('totalTasks').textContent = totalTasks;

            // Calculate streak (consecutive days with B+ or higher)
            const gradeThreshold = ['A+', 'A', 'A-', 'B+', 'B'];
            let streak = 0;
            for (let i = history.length - 1; i >= 0; i--) {
                const grade = history[i].userGrade || history[i].autoGrade;
                if (gradeThreshold.includes(grade)) {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('dayStreak').textContent = streak;

            // Calculate average grade
            const gradeValues = {
                'A+': 4.3, 'A': 4.0, 'A-': 3.7,
                'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                'C+': 2.3, 'C': 2.0, 'C-': 1.7,
                'D+': 1.3, 'D': 1.0, 'D-': 0.7,
                'F': 0.0
            };
            const avgGradeValue = history.reduce((sum, day) => {
                return sum + (gradeValues[day.userGrade || day.autoGrade] || 0);
            }, 0) / history.length;
            
            document.getElementById('avgGrade').textContent = avgGradeValue.toFixed(1);
            document.getElementById('focusScore').textContent = ((avgGradeValue / 4.3) * 100).toFixed(0) + '%';

            // Days logged
            document.getElementById('daysLogged').textContent = history.length;

            // Average distractions
            const avgDistractions = (history.reduce((sum, day) => sum + day.distractionCount, 0) / history.length).toFixed(1);
            document.getElementById('avgDistractions').textContent = avgDistractions;

            // Sprint completion rate
            const sprintRate = history.reduce((sum, day) => {
                return sum + Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
            }, 0) / history.length;
            document.getElementById('sprintRate').textContent = sprintRate.toFixed(0) + '%';

            // Weekly chart (last 7 days)
            const last7 = history.slice(-7);
            const chartHTML = last7.map(day => {
                const percentage = Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
                const color = percentage >= 100 ? '#22C55E' : '#ef4444';
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                return `
                    <div class="bar-mini">
                        <div class="bar-fill" style="height: ${percentage}%; background: ${color}"></div>
                        <div class="bar-day">${dayName}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('weeklyChart').innerHTML = chartHTML;

            // Intention vs Reality
            const intentions = JSON.parse(getUserItem('focushub_intentions') || '[]');
            const intentionCount = intentions.length;
            const followedThrough = intentions.filter(i => i.completed).length;
            
            document.getElementById('intentionCount').textContent = intentionCount;
            document.getElementById('realityCount').textContent = followedThrough;
            
            if (intentionCount > 0) {
                const intentionPercent = 100;
                const realityPercent = (followedThrough / intentionCount) * 100;
                document.getElementById('intentionFill').style.width = intentionPercent + '%';
                document.getElementById('realityFill').style.width = realityPercent + '%';
            }
            
            // Subject breakdown (student mode only)
            loadSubjectBreakdown();
        }
        
        // Calculate and display subject breakdown
        function loadSubjectBreakdown() {
            const config = window.loadModeConfig ? loadModeConfig() : null;
            const subjectSection = document.getElementById('subjectBreakdownSection');
            
            // Only show for student mode
            if (!config || !config.features || !config.features.subjects) {
                if (subjectSection) {
                    subjectSection.classList.add('hidden');
                }
                return;
            }
            
            // Show section
            if (subjectSection) {
                subjectSection.classList.remove('hidden');
            }
            
            // Get completed tasks from history
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            const subjectSprints = {};
            
            // Calculate sprints per subject from all history
            history.forEach(day => {
                if (day.wins && Array.isArray(day.wins)) {
                    day.wins.forEach(task => {
                        if (task.subject) {
                            subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                        }
                    });
                }
            });
            
            // Also check current tasks
            const currentTasks = JSON.parse(getUserItem('focushub_tasks') || '{"wins":[]}');
            if (currentTasks.wins && Array.isArray(currentTasks.wins)) {
                currentTasks.wins.forEach(task => {
                    if (task.subject) {
                        subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                    }
                });
            }
            
            // Render subject breakdown
            const breakdownEl = document.getElementById('subjectBreakdown');
            if (!breakdownEl) return;
            
            if (Object.keys(subjectSprints).length === 0) {
                breakdownEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No subjects tracked yet. Complete tasks with subjects to see breakdown.</p>';
                return;
            }
            
            const totalSprints = Object.values(subjectSprints).reduce((a, b) => a + b, 0);
            
            const html = Object.entries(subjectSprints)
                .sort((a, b) => b[1] - a[1]) // Sort by sprints descending
                .map(([subject, sprints]) => {
                    const percentage = ((sprints / totalSprints) * 100).toFixed(0);
                    return `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; color: var(--text-primary);">${subject}</span>
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">${sprints} sprints (${percentage}%)</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: var(--primary-color);"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            breakdownEl.innerHTML = html;
        }

        // Theme detection and logo swap
        function initTheme() {
            const theme = localStorage.getItem('focushub_theme') || 'light';
            const dashboardLogo = document.getElementById('dashboardLogo');
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                dashboardLogo.src = 'FocusHub_vertinv.svg';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                dashboardLogo.src = 'FocusHub_vertnorm.svg';
            }
        }

        // Check session state and update button
        function checkSessionState() {
            const sessionState = getUserItem('focushub_session_state');
            const dailyStats = getUserItem('focushub_daily_stats');
            const button = document.querySelector('.primary-action');
            
            // If session is active (not ended and has data)
            if (sessionState !== 'ended' && dailyStats) {
                const stats = JSON.parse(dailyStats);
                const today = new Date().toDateString();
                
                // Check if stats are from today
                if (stats.date === today) {
                    button.innerHTML = `
                        <span class="action-icon">[ &gt; ]</span>
                        <span class="action-text">RETURN TO WORKSPACE</span>
                    `;
                }
            }
        }

        // Update dashboard timer display
        function updateDashboardTimer() {
            const savedTimer = getUserItem('focushub_timer');
            if (!savedTimer) {
                document.getElementById('dashboardTimer').classList.add('hidden');
                return;
            }
            
            const timerData = JSON.parse(savedTimer);
            
            if (timerData.isRunning && timerData.timeLeft > 0) {
                // Calculate current time left
                const elapsed = Math.floor((Date.now() - timerData.lastUpdated) / 1000);
                const timeLeft = Math.max(0, timerData.timeLeft - elapsed);
                
                if (timeLeft > 0) {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    document.getElementById('dashboardTimerText').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    document.getElementById('dashboardTimer').classList.remove('hidden');
                    
                    // Update every second
                    setTimeout(updateDashboardTimer, 1000);
                } else {
                    document.getElementById('dashboardTimer').classList.add('hidden');
                }
            } else {
                document.getElementById('dashboardTimer').classList.add('hidden');
            }
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (window.handleFirebaseLogout) {
                window.handleFirebaseLogout();
            }
        });

        initTheme();
        checkSessionState();
        updateDashboardTimer();
        loadStats();
    </script>
</body>
</html>

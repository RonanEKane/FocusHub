<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusHub - Workspace</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Start Day Screen -->
    <div id="startDayScreen" class="start-day-screen">
        <div class="start-day-container">
            <img src="FocusHub_vertinv.png" alt="FocusHub" style="height: 80px; width: auto; margin: 0 auto 1rem; display: block;">
            <h1 class="start-title">Ready to Win Today?</h1>
            <p class="start-subtitle">Built for Brains That Wander, but Still Want to Win</p>

            <div class="start-form">
                <div class="form-group">
                    <label class="form-label">What's your energy level?</label>
                    <div class="energy-options">
                        <button class="energy-btn" data-energy="low">
                            <div class="energy-emoji">üîã</div>
                            <div>LOW</div>
                            <div class="energy-desc">15min sprints</div>
                        </button>
                        <button class="energy-btn active" data-energy="medium">
                            <div class="energy-emoji">‚ö°</div>
                            <div>MEDIUM</div>
                            <div class="energy-desc">20min sprints</div>
                        </button>
                        <button class="energy-btn" data-energy="high">
                            <div class="energy-emoji">üî•</div>
                            <div>HIGH</div>
                            <div class="energy-desc">30min sprints</div>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Baseline Sprint Target</label>
                    <div class="baseline-input-row">
                        <button class="baseline-btn" id="decreaseBaseline">‚àí</button>
                        <div class="baseline-value"><span id="baselineValue">5</span> sprints</div>
                        <button class="baseline-btn" id="increaseBaseline">+</button>
                    </div>
                    <div class="form-hint">Minimum sprints before task weights are added</div>
                </div>

                <button class="btn btn-primary btn-start" id="startDayBtn">Start My Day</button>
            </div>
        </div>
    </div>

    <!-- Main App (hidden initially) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-section">
                <img id="appLogo" src="FocusHub_vertinv.png" alt="FocusHub" class="logo-img" style="height: 40px; width: auto;">
                <p class="tagline">Built for Brains That Wander, but Still Want to Win</p>
            </div>
            
            <div class="header-controls">
                <a href="home.html" class="btn-home">üè† Home</a>
                <button id="themeToggle" class="btn-home">‚òÄÔ∏è Light</button>
                <button id="endDayBtn" class="btn-end-day">END DAY</button>
            </div>
        </header>

        <div class="app-container">
            <!-- Main Content (Left Column) -->
            <div class="main-content">
                <!-- Sprint Timer -->
                <div class="card sprint-timer">
                    <div class="card-header">
                        <h3 class="card-title" id="timerTitle">üéØ SPRINT TIMER</h3>
                        <div class="timer-meeting">
                            <button id="meetingBtn" class="btn-meeting">üìÖ Meeting</button>
                            <span id="meetingTime" class="meeting-time hidden">0m</span>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <div id="timerSetup" class="timer-setup">
                            <div class="energy-display">
                                Energy: <span id="energyDisplay" class="energy-medium">MEDIUM</span>
                            </div>
                            
                            <div class="duration-buttons">
                                <button class="duration-btn" data-duration="15">15 min</button>
                                <button class="duration-btn recommended" data-duration="20">20 min</button>
                                <button class="duration-btn" data-duration="30">30 min</button>
                            </div>
                        </div>

                        <div id="timerActive" class="timer-active hidden">
                            <div class="timer-display">
                                <div class="timer-time" id="timerTime">20:00</div>
                                <div class="timer-progress">
                                    <div class="progress-bar" id="progressBar"></div>
                                </div>
                            </div>
                            
                            <div class="timer-controls">
                                <button id="pauseBtn" class="btn btn-secondary">‚è∏ Pause</button>
                                <button id="resumeBtn" class="btn btn-primary hidden">‚ñ∂Ô∏è Resume</button>
                                <button id="resetBtn" class="btn btn-danger">üîÑ Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Manager -->
                <div class="card task-manager">
                    <div class="task-header">
                        <h2>‚ö° TASK COMMAND CENTER</h2>
                        <div class="sprint-target">
                            Target: <strong><span id="plannedSprints">5</span></strong> sprints
                        </div>
                    </div>

                    <!-- Brain Dump -->
                    <div class="brain-dump">
                        <label>üß† BRAIN DUMP</label>
                        <div class="input-row">
                            <select id="taskPriority" class="priority-select">
                                <option value="holding">üìã Holding</option>
                                <option value="urgent">üî• Urgent (1 sprint)</option>
                                <option value="deepwork">üéØ Deep Work (2 sprints)</option>
                                <option value="strategic">‚ôüÔ∏è Strategic (3 sprints)</option>
                            </select>
                            <input type="text" id="taskInput" placeholder="Type anything on your mind..." class="task-input">
                            <button id="addTaskBtn" class="btn btn-primary">Add</button>
                        </div>
                        
                        <!-- Holding Area -->
                        <div id="holdingArea" class="holding-area hidden">
                            <div class="holding-header">
                                <span>üìã HOLDING AREA</span>
                                <span class="task-count" id="holdingCount">0</span>
                            </div>
                            <div id="holdingList" class="task-list"></div>
                        </div>
                    </div>

                    <!-- Task Buckets -->
                    <div class="task-buckets">
                        <div class="task-bucket urgent" data-bucket="urgent">
                            <div class="bucket-header">
                                <span class="bucket-icon">üî•</span>
                                <h3>URGENT</h3>
                                <span class="task-count" id="urgentCount">0</span>
                            </div>
                            <div id="urgentList" class="task-list"></div>
                        </div>

                        <div class="task-bucket deepwork" data-bucket="deepwork">
                            <div class="bucket-header">
                                <span class="bucket-icon">üéØ</span>
                                <h3>DEEP WORK</h3>
                                <span class="task-count" id="deepworkCount">0</span>
                            </div>
                            <div id="deepworkList" class="task-list"></div>
                        </div>

                        <div class="task-bucket strategic" data-bucket="strategic">
                            <div class="bucket-header">
                                <span class="bucket-icon">‚ôüÔ∏è</span>
                                <h3>STRATEGIC</h3>
                                <span class="task-count" id="strategicCount">0</span>
                            </div>
                            <div id="strategicList" class="task-list"></div>
                        </div>
                    </div>

                    <!-- Today's Wins -->
                    <div id="winsSection" class="wins-section hidden">
                        <div class="wins-header">
                            <h3>‚úÖ TODAY'S WINS</h3>
                        </div>
                        <div id="winsList" class="wins-list"></div>
                    </div>

                    <div class="task-weights-legend">
                        <small><strong>Sprint Values:</strong> Strategic (3) ¬∑ Deep Work (2) ¬∑ Urgent (1)</small>
                    </div>
                </div>

                <!-- Distraction Logger with Intention Tracking -->
                <div class="card distraction-logger">
                    <div class="card-header">
                        <h3 class="card-title">üö´ DISTRACTION PARKING</h3>
                        <span class="distraction-count" id="distractionCount">0</span>
                    </div>
                    
                    <div class="card-content">
                        <!-- Add Intention Toggle -->
                        <div class="distraction-input-group">
                            <input type="text" id="distractionInput" class="distraction-input" placeholder="Park that distraction here...">
                            <label class="intention-checkbox">
                                <input type="checkbox" id="intentionCheck">
                                <span>I'll handle this</span>
                            </label>
                            <button id="parkDistractionBtn" class="btn btn-primary">Park It</button>
                        </div>

                        <div id="distractionList" class="distraction-list"></div>
                    </div>
                </div>

                <!-- Progress Tracker -->
                <div class="card progress-tracker">
                    <h3 class="card-title">üìä TODAY'S PROGRESS</h3>
                    <div class="progress-grid">
                        <div class="progress-item">
                            <div class="progress-label">Sprints</div>
                            <div class="progress-value"><span id="sprintProgress">0</span> / <span id="sprintTarget">5</span></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">Tasks</div>
                            <div class="progress-value" id="taskProgress">0</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">Distractions</div>
                            <div class="progress-value" id="distractionProgress">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar (Right Column - NOT STICKY) -->
            <div class="sidebar-column">
                <!-- NEW: Tough Love Toggle -->
                <div class="card tough-love-card">
                    <h3 class="card-title">üí™ TOUGH LOVE MODE</h3>
                    <div class="tough-love-selector">
                        <button class="tough-love-btn" data-level="supportive">Supportive</button>
                        <button class="tough-love-btn active" data-level="balanced">Balanced</button>
                        <button class="tough-love-btn" data-level="tough">Tough</button>
                    </div>
                    <p class="tough-love-desc">Changes how the AI Agent talks to you</p>
                </div>

                <!-- AI Agent -->
                <div class="card ai-agent">
                    <h3 class="card-title">ü§ñ AI AGENT</h3>
                    <div class="agent-message">
                        <div class="agent-text" id="agentText">Start your first sprint to get feedback.</div>
                    </div>
                </div>

                <!-- Grade Preview -->
                <div class="card grade-preview">
                    <h3 class="card-title">üìà CURRENT GRADE</h3>
                    <div class="grade-display">
                        <div class="grade-large" id="currentGrade">-</div>
                        <div class="grade-context">Based on current progress</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <a href="index.html">Home</a>
            <span class="footer-separator">|</span>
            <a href="home.html">Dashboard</a>
        </footer>
    </div>

    <!-- Morning Reflection Modal -->
    <div id="morningModal" class="modal-overlay hidden">
        <div class="modal morning-modal">
            <div class="modal-header">
                <h2>üåÖ Morning Reflection</h2>
            </div>
            
            <div class="modal-body">
                <div class="reflection-content" id="reflectionContent">
                    <p class="reflection-text">
                        The day stretches before you like an empty canvas. What you choose to place on it reflects not just your plans, but your character. Discipline is not a burden placed upon you by others‚Äîit is the gift you give to your future self. Today, you have the power to honor your commitments or to excuse your failures. Choose deliberately.
                    </p>
                    <p class="reflection-attribution">‚Äî On Discipline and Duty</p>
                </div>
                
                <button id="generateReflection" class="btn btn-secondary" style="width: 100%; margin: 1rem 0;">Generate New Reflection</button>
                
                <div class="morning-note">
                    <strong>Remember:</strong> This is direction, not motivation. Reflect on it, then get to work.
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="closeMorningBtn" class="btn btn-primary">Begin Day</button>
            </div>
        </div>
    </div>

    <!-- End of Day Modal -->
    <div id="eodModal" class="modal-overlay hidden">
        <div class="modal eod-modal">
            <div class="modal-header">
                <h2>üìä End of Day Report</h2>
            </div>
            
            <div class="modal-body">
                <div class="day-stats">
                    <div class="stat-card">
                        <div class="stat-label">Sprints</div>
                        <div class="stat-value"><span id="eodSprints">0</span> / <span id="eodPlanned">5</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tasks</div>
                        <div class="stat-value" id="eodTasks">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Distractions</div>
                        <div class="stat-value" id="eodDistractions">0</div>
                    </div>
                </div>

                <div class="grade-display">
                    <div class="grade-section">
                        <div class="grade-label">System Grade</div>
                        <div class="grade-value" id="systemGrade">-</div>
                    </div>
                    
                    <div class="grade-section">
                        <div class="grade-label">Your Grade</div>
                        <div class="grade-value" id="userGrade">-</div>
                        <div class="grade-selector">
                            <button class="grade-btn" data-grade="A+">A+</button>
                            <button class="grade-btn" data-grade="A">A</button>
                            <button class="grade-btn" data-grade="A-">A-</button>
                            <button class="grade-btn" data-grade="B+">B+</button>
                            <button class="grade-btn" data-grade="B">B</button>
                            <button class="grade-btn" data-grade="B-">B-</button>
                            <button class="grade-btn" data-grade="C+">C+</button>
                            <button class="grade-btn" data-grade="C">C</button>
                            <button class="grade-btn" data-grade="C-">C-</button>
                            <button class="grade-btn" data-grade="D+">D+</button>
                            <button class="grade-btn" data-grade="D">D</button>
                            <button class="grade-btn" data-grade="D-">D-</button>
                            <button class="grade-btn" data-grade="F">F</button>
                        </div>
                    </div>
                </div>

                <div class="reflection-section">
                    <label class="reflection-label">What went well? What could improve?</label>
                    <textarea id="reflectionInput" class="reflection-input" placeholder="Your thoughts..." rows="4"></textarea>
                </div>

                <div class="eod-note">
                    ‚ÑπÔ∏è Unfinished tasks and distractions will remain for tomorrow
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="completeDayBtn" class="btn btn-primary">Complete Day</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            energyLevel: 'medium',
            baselineSprints: 5,
            plannedSprints: 5,
            sprintCount: 0,
            distractionCount: 0,
            tasksCompleted: 0,
            meetingMinutes: 0,
            toughLoveLevel: 'balanced',
            timer: {
                timeLeft: 0,
                duration: 0,
                isRunning: false,
                timerType: 'focus',
                interval: null
            },
            meeting: {
                active: false,
                startTime: null
            },
            tasks: {
                holding: [],
                urgent: [],
                deepwork: [],
                strategic: [],
                wins: []
            },
            distractions: [],
            intentions: []
        };

        const TASK_WEIGHTS = {
            strategic: 3,
            deepwork: 2,
            urgent: 1,
            holding: 0
        };

        const ENERGY_DURATIONS = {
            low: 15,
            medium: 20,
            high: 30
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            loadState();
            setupEventListeners();
            checkSessionState();
        }

        function loadState() {
            const today = new Date().toDateString();
            
            // Load daily stats
            const savedStats = localStorage.getItem('focushub_daily_stats');
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                if (stats.date === today) {
                    state.sprintCount = stats.sprintCount || 0;
                    state.distractionCount = stats.distractionCount || 0;
                    state.tasksCompleted = stats.tasksCompleted || 0;
                    state.meetingMinutes = stats.meetingMinutes || 0;
                    state.plannedSprints = stats.plannedSprints || 5;
                }
            }

            // Load tasks
            const savedTasks = localStorage.getItem('focushub_tasks');
            if (savedTasks) {
                state.tasks = JSON.parse(savedTasks);
            }

            // Load distractions
            const savedDistractions = localStorage.getItem('focushub_distractions');
            if (savedDistractions) {
                state.distractions = JSON.parse(savedDistractions);
            }

            // Load intentions
            const savedIntentions = localStorage.getItem('focushub_intentions');
            if (savedIntentions) {
                state.intentions = JSON.parse(savedIntentions);
            }

            // Load tough love level
            const savedToughLove = localStorage.getItem('focushub_tough_love');
            if (savedToughLove) {
                state.toughLoveLevel = savedToughLove;
            }
        }

        function saveState() {
            const today = new Date().toDateString();
            
            const stats = {
                sprintCount: state.sprintCount,
                distractionCount: state.distractionCount,
                tasksCompleted: state.tasksCompleted,
                meetingMinutes: state.meetingMinutes,
                plannedSprints: state.plannedSprints,
                date: today
            };
            localStorage.setItem('focushub_daily_stats', JSON.stringify(stats));
            localStorage.setItem('focushub_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('focushub_distractions', JSON.stringify(state.distractions));
            localStorage.setItem('focushub_intentions', JSON.stringify(state.intentions));
            localStorage.setItem('focushub_tough_love', state.toughLoveLevel);
        }

        function checkSessionState() {
            const sessionState = localStorage.getItem('focushub_session_state');
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('focushub_session_date');

            if (lastDate !== today) {
                // New day
                localStorage.setItem('focushub_session_state', 'not_started');
                localStorage.setItem('focushub_session_date', today);
                showStartScreen();
            } else if (sessionState === 'active') {
                hideStartScreen();
                renderAll();
            } else {
                showStartScreen();
            }
        }

        // ============================================
        // START DAY SCREEN
        // ============================================
        function setupEventListeners() {
            // Start Day Screen
            document.querySelectorAll('.energy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.energy-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    state.energyLevel = e.currentTarget.dataset.energy;
                });
            });

            document.getElementById('decreaseBaseline').addEventListener('click', () => {
                const current = parseInt(document.getElementById('baselineValue').textContent);
                if (current > 0) {
                    document.getElementById('baselineValue').textContent = current - 1;
                }
            });

            document.getElementById('increaseBaseline').addEventListener('click', () => {
                const current = parseInt(document.getElementById('baselineValue').textContent);
                document.getElementById('baselineValue').textContent = current + 1;
            });

            document.getElementById('startDayBtn').addEventListener('click', startDay);

            // Timer controls
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const duration = parseInt(e.currentTarget.dataset.duration);
                    startTimer(duration);
                });
            });

            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('resumeBtn').addEventListener('click', resumeTimer);
            document.getElementById('resetBtn').addEventListener('click', resetTimer);

            // Meeting
            document.getElementById('meetingBtn').addEventListener('click', toggleMeeting);

            // Tasks
            document.getElementById('addTaskBtn').addEventListener('click', addTask);
            document.getElementById('taskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });

            // Distractions
            document.getElementById('parkDistractionBtn').addEventListener('click', addDistraction);
            document.getElementById('distractionInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addDistraction();
            });

            // Tough Love
            document.querySelectorAll('.tough-love-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tough-love-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    state.toughLoveLevel = e.currentTarget.dataset.level;
                    saveState();
                    updateAgentMessage();
                });
            });

            // End of Day
            document.getElementById('endDayBtn').addEventListener('click', showEndOfDayModal);
            document.querySelectorAll('.grade-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    document.getElementById('userGrade').textContent = e.currentTarget.dataset.grade;
                });
            });
            document.getElementById('completeDayBtn').addEventListener('click', completeDay);
        }

        function showStartScreen() {
            document.getElementById('startDayScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function hideStartScreen() {
            document.getElementById('startDayScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function startDay() {
            state.baselineSprints = parseInt(document.getElementById('baselineValue').textContent);
            state.plannedSprints = state.baselineSprints;
            
            // Set cookie for returning user
            document.cookie = "focushub_returning_user=true; path=/; max-age=31536000";
            
            localStorage.setItem('focushub_session_state', 'active');
            hideStartScreen();
            renderAll();
            updateAgentMessage();
        }

        // ============================================
        // TIMER
        // ============================================
        function startTimer(duration) {
            state.timer.duration = duration * 60;
            state.timer.timeLeft = duration * 60;
            state.timer.isRunning = true;
            state.timer.timerType = 'focus';

            document.getElementById('timerSetup').classList.add('hidden');
            document.getElementById('timerActive').classList.remove('hidden');
            document.getElementById('timerTitle').textContent = 'üéØ SPRINT TIMER';

            state.timer.interval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (state.timer.timeLeft > 0) {
                state.timer.timeLeft--;
                renderTimer();
            } else {
                completeTimer();
            }
        }

        function renderTimer() {
            const mins = Math.floor(state.timer.timeLeft / 60);
            const secs = state.timer.timeLeft % 60;
            document.getElementById('timerTime').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            const progress = ((state.timer.duration - state.timer.timeLeft) / state.timer.duration) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function pauseTimer() {
            state.timer.isRunning = false;
            clearInterval(state.timer.interval);
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('resumeBtn').classList.remove('hidden');
        }

        function resumeTimer() {
            state.timer.isRunning = true;
            state.timer.interval = setInterval(updateTimer, 1000);
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('resumeBtn').classList.add('hidden');
        }

        function resetTimer() {
            clearInterval(state.timer.interval);
            state.timer.timeLeft = 0;
            state.timer.isRunning = false;
            document.getElementById('timerSetup').classList.remove('hidden');
            document.getElementById('timerActive').classList.add('hidden');
        }

        function completeTimer() {
            clearInterval(state.timer.interval);
            
            if (state.timer.timerType === 'focus') {
                state.sprintCount++;
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                // Auto-start break
                state.timer.timerType = 'break';
                state.timer.duration = 5 * 60;
                state.timer.timeLeft = 5 * 60;
                state.timer.interval = setInterval(updateTimer, 1000);
                document.getElementById('timerTitle').textContent = '‚òï BREAK TIME';
            } else {
                // Break complete
                resetTimer();
            }
            
            saveState();
            renderAll();
            updateAgentMessage();
        }

        // ============================================
        // MEETING TRACKER
        // ============================================
        function toggleMeeting() {
            if (state.meeting.active) {
                // End meeting
                const elapsed = Math.floor((Date.now() - state.meeting.startTime) / 1000 / 60);
                state.meetingMinutes += elapsed;
                state.meeting.active = false;
                state.meeting.startTime = null;
                document.getElementById('meetingBtn').textContent = 'üìÖ Meeting';
                document.getElementById('meetingTime').classList.add('hidden');
            } else {
                // Start meeting
                state.meeting.active = true;
                state.meeting.startTime = Date.now();
                document.getElementById('meetingBtn').textContent = 'üî¥ End Meeting';
                document.getElementById('meetingTime').classList.remove('hidden');
                
                // Update meeting time every minute
                setInterval(() => {
                    if (state.meeting.active) {
                        const elapsed = Math.floor((Date.now() - state.meeting.startTime) / 1000 / 60);
                        document.getElementById('meetingTime').textContent = elapsed + 'm';
                    }
                }, 60000);
            }
            saveState();
        }

        // ============================================
        // TASK MANAGEMENT
        // ============================================
        function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            const priority = document.getElementById('taskPriority').value;
            
            if (!text) return;
            
            const task = {
                id: Date.now(),
                text: text,
                createdAt: new Date().toISOString()
            };
            
            state.tasks[priority].push(task);
            input.value = '';
            document.getElementById('taskPriority').value = 'holding';
            
            calculatePlannedSprints();
            saveState();
            renderTasks();
        }

        function calculatePlannedSprints() {
            let total = state.baselineSprints;
            total += state.tasks.urgent.length * TASK_WEIGHTS.urgent;
            total += state.tasks.deepwork.length * TASK_WEIGHTS.deepwork;
            total += state.tasks.strategic.length * TASK_WEIGHTS.strategic;
            state.plannedSprints = total;
        }

        function completeTask(bucket, taskId) {
            const task = state.tasks[bucket].find(t => t.id === taskId);
            if (!task) return;
            
            state.tasks[bucket] = state.tasks[bucket].filter(t => t.id !== taskId);
            state.tasks.wins.push({ ...task, completedAt: new Date().toISOString() });
            state.tasksCompleted++;
            
            calculatePlannedSprints();
            saveState();
            renderTasks();
            updateAgentMessage();
        }

        function deleteTask(bucket, taskId) {
            state.tasks[bucket] = state.tasks[bucket].filter(t => t.id !== taskId);
            calculatePlannedSprints();
            saveState();
            renderTasks();
        }

        function renderTasks() {
            // Render each bucket
            ['holding', 'urgent', 'deepwork', 'strategic'].forEach(bucket => {
                const listEl = document.getElementById(bucket + 'List');
                const countEl = document.getElementById(bucket + 'Count');
                
                if (countEl) countEl.textContent = state.tasks[bucket].length;
                
                if (bucket === 'holding') {
                    const container = document.getElementById('holdingArea');
                    if (state.tasks.holding.length > 0) {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                }
                
                if (listEl) {
                    listEl.innerHTML = state.tasks[bucket].map(task => `
                        <div class="task-item">
                            ${bucket !== 'holding' ? `<input type="checkbox" class="task-checkbox" onclick="completeTask('${bucket}', ${task.id})">` : ''}
                            <span class="task-text">${task.text}</span>
                            <button class="task-delete" onclick="deleteTask('${bucket}', ${task.id})">√ó</button>
                        </div>
                    `).join('');
                }
            });

            // Render wins
            const winsSection = document.getElementById('winsSection');
            const winsList = document.getElementById('winsList');
            
            if (state.tasks.wins.length > 0) {
                winsSection.classList.remove('hidden');
                winsList.innerHTML = state.tasks.wins.map(task => `
                    <div class="win-item">
                        <span class="win-check">‚úì</span>
                        <span class="win-text">${task.text}</span>
                    </div>
                `).join('');
            } else {
                winsSection.classList.add('hidden');
            }

            document.getElementById('plannedSprints').textContent = state.plannedSprints;
        }

        // ============================================
        // DISTRACTION MANAGEMENT
        // ============================================
        function addDistraction() {
            const input = document.getElementById('distractionInput');
            const text = input.value.trim();
            const isIntention = document.getElementById('intentionCheck').checked;
            
            if (!text) return;
            
            const distraction = {
                id: Date.now(),
                text: text,
                timestamp: new Date().toISOString()
            };
            
            state.distractions.push(distraction);
            state.distractionCount++;
            
            if (isIntention) {
                state.intentions.push({
                    id: Date.now(),
                    distractionId: distraction.id,
                    text: text,
                    declared: new Date().toISOString(),
                    completed: false
                });
            }
            
            input.value = '';
            document.getElementById('intentionCheck').checked = false;
            
            saveState();
            renderDistractions();
            updateAgentMessage();
        }

        function removeDistraction(id) {
            state.distractions = state.distractions.filter(d => d.id !== id);
            
            // Check if this was an intention
            const intention = state.intentions.find(i => i.distractionId === id);
            if (intention) {
                intention.completed = true;
            }
            
            saveState();
            renderDistractions();
        }

        function renderDistractions() {
            const list = document.getElementById('distractionList');
            document.getElementById('distractionCount').textContent = state.distractions.length;
            
            list.innerHTML = state.distractions.map(d => {
                const isIntention = state.intentions.some(i => i.distractionId === d.id);
                return `
                    <div class="distraction-item ${isIntention ? 'is-intention' : ''}">
                        ${isIntention ? '<span class="intention-badge">üí™</span>' : ''}
                        <div class="distraction-text">${d.text}</div>
                        <button class="distraction-delete" onclick="removeDistraction(${d.id})">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // AI AGENT
        // ============================================
        function updateAgentMessage() {
            const messages = {
                supportive: {
                    start: "You've got this! Take it one sprint at a time.",
                    progress: `Great work! ${state.sprintCount} sprints completed. Keep the momentum going.`,
                    struggling: `${state.distractionCount} distractions so far. That's okay. Just park them and refocus.`,
                    winning: `You're crushing it today! ${state.tasksCompleted} tasks done. Stay focused.`
                },
                balanced: {
                    start: "Focus on the next sprint. Everything else can wait.",
                    progress: `${state.sprintCount}/${state.plannedSprints} sprints. Stay on pace.`,
                    struggling: `${state.distractionCount} distractions. Log them, then get back to work.`,
                    winning: `${state.sprintCount} sprints, ${state.tasksCompleted} tasks. Good pace.`
                },
                tough: {
                    start: "Stop thinking. Start the timer.",
                    progress: `${state.sprintCount}/${state.plannedSprints}. You're behind. Move faster.`,
                    struggling: `${state.distractionCount} distractions already? Focus or quit.`,
                    winning: `${state.sprintCount} sprints. Don't get cocky. Finish strong.`
                }
            };

            const level = state.toughLoveLevel;
            let message = messages[level].start;

            if (state.sprintCount > 0) {
                if (state.sprintCount >= state.plannedSprints) {
                    message = messages[level].winning;
                } else if (state.distractionCount > 5) {
                    message = messages[level].struggling;
                } else {
                    message = messages[level].progress;
                }
            }

            document.getElementById('agentText').textContent = message;
        }

        // ============================================
        // GRADING
        // ============================================
        function calculateGrade() {
            const sprintScore = Math.min((state.sprintCount / state.plannedSprints) * 100, 100);
            const distractionPenalty = state.distractionCount * 5;
            const finalScore = Math.max(sprintScore - distractionPenalty, 0);
            
            if (finalScore >= 97) return 'A+';
            if (finalScore >= 93) return 'A';
            if (finalScore >= 90) return 'A-';
            if (finalScore >= 87) return 'B+';
            if (finalScore >= 83) return 'B';
            if (finalScore >= 80) return 'B-';
            if (finalScore >= 77) return 'C+';
            if (finalScore >= 73) return 'C';
            if (finalScore >= 70) return 'C-';
            if (finalScore >= 67) return 'D+';
            if (finalScore >= 63) return 'D';
            if (finalScore >= 60) return 'D-';
            return 'F';
        }

        function updateCurrentGrade() {
            const grade = calculateGrade();
            document.getElementById('currentGrade').textContent = grade;
        }

        // ============================================
        // END OF DAY
        // ============================================
        function showEndOfDayModal() {
            document.getElementById('eodSprints').textContent = state.sprintCount;
            document.getElementById('eodPlanned').textContent = state.plannedSprints;
            document.getElementById('eodTasks').textContent = state.tasksCompleted;
            document.getElementById('eodDistractions').textContent = state.distractionCount;
            
            const autoGrade = calculateGrade();
            document.getElementById('systemGrade').textContent = autoGrade;
            document.getElementById('userGrade').textContent = autoGrade;
            
            // Select the auto grade button
            document.querySelectorAll('.grade-btn').forEach(btn => {
                if (btn.dataset.grade === autoGrade) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.getElementById('eodModal').classList.remove('hidden');
        }

        function completeDay() {
            const today = new Date().toDateString();
            const autoGrade = calculateGrade();
            const userGrade = document.getElementById('userGrade').textContent;
            const reflection = document.getElementById('reflectionInput').value;
            
            const report = {
                date: today,
                sprintCount: state.sprintCount,
                plannedSprints: state.plannedSprints,
                distractionCount: state.distractionCount,
                tasksCompleted: state.tasksCompleted,
                meetingMinutes: state.meetingMinutes,
                autoGrade: autoGrade,
                userGrade: userGrade,
                gradesMatch: autoGrade === userGrade,
                reflection: reflection,
                score: Math.min((state.sprintCount / state.plannedSprints) * 100, 100),
                timestamp: new Date().toISOString()
            };
            
            const history = JSON.parse(localStorage.getItem('focushub_history') || '[]');
            history.push(report);
            localStorage.setItem('focushub_history', JSON.stringify(history));
            
            localStorage.setItem('focushub_session_state', 'ended');
            
            window.location.href = 'home.html';
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderAll() {
            renderTasks();
            renderDistractions();
            updateCurrentGrade();
            
            document.getElementById('sprintProgress').textContent = state.sprintCount;
            document.getElementById('sprintTarget').textContent = state.plannedSprints;
            document.getElementById('taskProgress').textContent = state.tasksCompleted;
            document.getElementById('distractionProgress').textContent = state.distractionCount;
            
            // Set energy display
            const energyEl = document.getElementById('energyDisplay');
            energyEl.textContent = state.energyLevel.toUpperCase();
            energyEl.className = 'energy-' + state.energyLevel;
            
            // Set recommended timer button
            const recommendedDuration = ENERGY_DURATIONS[state.energyLevel];
            document.querySelectorAll('.duration-btn').forEach(btn => {
                if (parseInt(btn.dataset.duration) === recommendedDuration) {
                    btn.classList.add('recommended');
                } else {
                    btn.classList.remove('recommended');
                }
            });

            // Set tough love active button
            document.querySelectorAll('.tough-love-btn').forEach(btn => {
                if (btn.dataset.level === state.toughLoveLevel) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Initialize app
        init();

        // ============================================
        // THEME TOGGLE
        // ============================================
        const themeToggle = document.getElementById('themeToggle');
        const appLogo = document.getElementById('appLogo');
        
        function initTheme() {
            const savedTheme = localStorage.getItem('focushub_theme') || 'light';
            setTheme(savedTheme);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('focushub_theme', theme);
            
            // Update toggle button
            if (theme === 'dark') {
                themeToggle.textContent = 'üåô Dark';
                appLogo.src = 'FocusHub_vertnorm.png'; // All-orange icon for dark mode
            } else {
                themeToggle.textContent = '‚òÄÔ∏è Light';
                appLogo.src = 'FocusHub_vertinv.png'; // Orange/White/Black icon for light mode
            }
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = current === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        themeToggle.addEventListener('click', toggleTheme);
        initTheme();

        // ============================================
        // MORNING REFLECTION
        // ============================================
        const morningModal = document.getElementById('morningModal');
        const closeMorningBtn = document.getElementById('closeMorningBtn');
        const generateReflection = document.getElementById('generateReflection');
        const reflectionContent = document.getElementById('reflectionContent');
        
        const reflections = [
            {
                text: "The day stretches before you like an empty canvas. What you choose to place on it reflects not just your plans, but your character. Discipline is not a burden placed upon you by others‚Äîit is the gift you give to your future self. Today, you have the power to honor your commitments or to excuse your failures. Choose deliberately.",
                attribution: "On Discipline and Duty"
            },
            {
                text: "You will be tempted to drift. Your attention will be pulled in a dozen directions. This is not a moral failing‚Äîthis is the nature of the mind. But you are not merely your impulses. You possess the capacity to redirect, to refocus, to persist. Use it. The scattered mind achieves nothing. The focused mind moves mountains.",
                attribution: "On Focus and Perseverance"
            },
            {
                text: "Today, you will face resistance. The voice that says 'later' or 'not now' or 'this doesn't matter.' That voice is not wisdom. It is entropy. Progress requires you to act against comfort, against ease, against the path of least resistance. This is not punishment. This is the price of growth.",
                attribution: "On Resistance and Growth"
            },
            {
                text: "You are not here to feel productive. You are here to produce. Feelings follow action, not the other way around. Start before you feel ready. Work before you feel motivated. The path forward is not paved with perfect conditions‚Äîit is built by imperfect effort, repeated daily.",
                attribution: "On Action Over Feeling"
            },
            {
                text: "Each task before you is an opportunity to practice integrity. Not the integrity of grand gestures, but the integrity of small promises kept. When you say you will do something, and then you do it, you build trust with yourself. This is the foundation of all achievement.",
                attribution: "On Integrity and Trust"
            },
            {
                text: "The work you avoid today does not disappear‚Äîit compounds. Every delay adds weight to tomorrow's burden. But the inverse is also true: every task completed today lightens tomorrow's load. You control which future you create. Choose wisely.",
                attribution: "On Time and Consequence"
            },
            {
                text: "Excellence is not a destination. It is a practice. Today, you will not achieve perfection. You will achieve effort. String enough days of effort together, and you will look back surprised at what you have built. But first, you must begin.",
                attribution: "On Excellence Through Practice"
            },
            {
                text: "Your energy is finite. Your attention is finite. Every distraction is not merely a loss of time‚Äîit is a theft of potential. Guard your focus as you would guard your most valuable possession. Because it is.",
                attribution: "On Stewardship of Attention"
            },
            {
                text: "Today, you may fail. You may fall short of your target, succumb to distraction, or lose focus. This does not make you a failure. It makes you human. What matters is not perfection, but the choice to return tomorrow and try again. Persistence outlasts talent.",
                attribution: "On Failure and Persistence"
            },
            {
                text: "The tasks before you are not obstacles to your life. They are your life. This moment, this work, this effort‚Äîthis is not the preamble to something greater. This is it. Be here. Do this. Make it count.",
                attribution: "On Presence and Purpose"
            }
        ];
        
        function showMorningReflection() {
            // Check if already shown today
            const today = new Date().toDateString();
            const lastShown = localStorage.getItem('focushub_morning_reflection_date');
            
            if (lastShown === today) {
                return; // Already shown today
            }
            
            // Load or generate reflection
            loadReflection();
            morningModal.classList.remove('hidden');
        }
        
        function loadReflection() {
            const savedReflection = localStorage.getItem('focushub_current_reflection');
            let reflection;
            
            if (savedReflection) {
                reflection = JSON.parse(savedReflection);
            } else {
                reflection = reflections[Math.floor(Math.random() * reflections.length)];
                localStorage.setItem('focushub_current_reflection', JSON.stringify(reflection));
            }
            
            reflectionContent.innerHTML = `
                <p class="reflection-text">${reflection.text}</p>
                <p class="reflection-attribution">‚Äî ${reflection.attribution}</p>
            `;
        }
        
        function generateNewReflection() {
            const reflection = reflections[Math.floor(Math.random() * reflections.length)];
            localStorage.setItem('focushub_current_reflection', JSON.stringify(reflection));
            reflectionContent.innerHTML = `
                <p class="reflection-text">${reflection.text}</p>
                <p class="reflection-attribution">‚Äî ${reflection.attribution}</p>
            `;
        }
        
        function closeMorningReflection() {
            morningModal.classList.add('hidden');
            const today = new Date().toDateString();
            localStorage.setItem('focushub_morning_reflection_date', today);
        }
        
        closeMorningBtn.addEventListener('click', closeMorningReflection);
        generateReflection.addEventListener('click', generateNewReflection);
        
        // Show morning reflection after day starts (if not shown today)
        setTimeout(() => {
            if (state.sessionState !== 'not_started') {
                showMorningReflection();
            }
        }, 1000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusHub - Built for Brains That Wander, but Still Want to Win</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="logo-section">
            <div style="position: relative; display: inline-block;">
                <img id="appLogo" src="FocusHub_horiinv.svg" alt="FocusHub" style="height: 32px; width: auto;">
                <span style="position: absolute; top: -6px; right: -38px; background: #f45b07; color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 3px; letter-spacing: 0.5px;">BETA</span>
            </div>
            <p class="tagline">Built for Brains That Wander, but Still Want to Win</p>
        </div>
        <div class="header-actions">
            <button class="btn" id="dashboardBtn">üìä Dashboard</button>
            <button class="btn" id="themeToggle">üåô Dark</button>
            <button class="btn" id="logoutBtn">Logout</button>
            <button class="btn btn-danger" id="endDayBtn">END DAY</button>
        </div>
    </header>

    <!-- System State Indicator -->
    <div class="system-state-bar">
        <span id="systemState">System idle. Start a sprint to begin.</span>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Left Column: Main Content -->
        <main class="main-content">
            <!-- Sprint Timer Section - DOMINANT -->
            <section class="sprint-timer-section dominant">
                <div class="section-header">
                    <h2>‚è±Ô∏è SPRINT TIMER</h2>
                </div>
                
                <div class="energy-row">
                    <div class="energy-select">
                        <label>Energy:</label>
                        <select id="energyLevel">
                            <option value="low">‚ö° Kinda "Meh" (15 min)</option>
                            <option value="medium" selected>‚ö°‚ö° Solid (20 min)</option>
                            <option value="high">‚ö°‚ö°‚ö° Locked In (30 min)</option>
                        </select>
                    </div>
                    <label class="meeting-toggle">
                        <input type="checkbox" id="meetingToggle"> Meeting
                    </label>
                </div>

                <div class="timer-buttons">
                    <button class="timer-btn" data-duration="15">15 min</button>
                    <button class="timer-btn active" data-duration="20">20 min</button>
                    <button class="timer-btn" data-duration="30">30 min</button>
                    <button class="timer-btn timer-btn-break" data-duration="5">Break</button>
                </div>

                <!-- LARGE TIMER DISPLAY -->
                <div class="timer-display-large" id="timerDisplay">
                    <div class="timer-value">20:00</div>
                    <div class="timer-status">Ready to start</div>
                </div>

                <button class="btn-start-sprint" id="startSprintBtn">START SPRINT</button>
            </section>

            <!-- Task Command Center -->
            <section class="task-section">
                <div class="section-header">
                    <h2>‚ö° TASK COMMAND CENTER</h2>
                    <span class="sprint-target">Target: <span id="sprintTarget">5</span> sprints</span>
                </div>

                <div class="task-input-wrapper">
                    <label class="input-label">WHAT NEEDS DOING?</label>
                    <p class="input-hint">Paste your task list below (one task per line)</p>
                    <textarea id="taskInput" class="task-textarea" placeholder="Add Task"></textarea>
                </div>

                <button class="parse-btn" id="parseBtn">PARSE & ADD TO HOLDING AREA</button>

                <!-- Holding Area -->
                <div class="holding-area">
                    <div class="holding-header">
                        <h3>üì¶ Holding Area</h3>
                        <span class="task-count" id="holdingCount">0</span>
                    </div>
                    <div id="holdingTasks" class="task-list" data-bucket="holding">
                        <p class="empty-state">Tasks will appear here</p>
                    </div>
                </div>

                <!-- THREE BUCKETS -->
                <div class="buckets-grid">
                    <!-- ADMIN Bucket -->
                    <div class="bucket">
                        <div class="bucket-header">
                            <h3>üìã ADMIN</h3>
                            <span class="bucket-count" id="adminCount">0</span>
                        </div>
                        <div id="adminBucket" class="task-list" data-bucket="admin">
                            <p class="empty-state-small">Drag tasks here</p>
                        </div>
                    </div>

                    <!-- DEEP WORK Bucket -->
                    <div class="bucket">
                        <div class="bucket-header">
                            <h3>üéØ DEEP WORK</h3>
                            <span class="bucket-count" id="deepworkCount">0</span>
                        </div>
                        <div id="deepworkBucket" class="task-list" data-bucket="deepwork">
                            <p class="empty-state-small">Drag tasks here</p>
                        </div>
                    </div>

                    <!-- STRATEGIC Bucket -->
                    <div class="bucket">
                        <div class="bucket-header">
                            <h3>üé≤ STRATEGIC</h3>
                            <span class="bucket-count" id="strategicCount">0</span>
                        </div>
                        <div id="strategicBucket" class="task-list" data-bucket="strategic">
                            <p class="empty-state-small">Drag tasks here</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Right Column: Sidebar -->
        <aside class="sidebar">
            <!-- System Intelligence with Grade -->
            <div class="sidebar-card system-intelligence">
                <div class="card-header-with-control">
                    <h3>ü§ñ SYSTEM INTELLIGENCE</h3>
                    <div class="header-controls">
                        <span class="grade-mini" id="gradeMini">-</span>
                        <select id="agentMode" class="agent-mode-dropdown">
                            <option value="supportive">Supportive</option>
                            <option value="balanced" selected>Balanced</option>
                            <option value="tough">Tough</option>
                        </select>
                    </div>
                </div>
                <div class="ai-message-large" id="aiMessage">
                    Ready to execute. Let's go.
                </div>
            </div>

            <!-- Stats -->
            <div class="sidebar-card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">SPRINTS</div>
                        <div class="stat-value"><span id="sprintsDone">0</span> / <span id="sprintsTotal">5</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">WINS</div>
                        <div class="stat-value" id="winsCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">BREAKS</div>
                        <div class="stat-value" id="breaksCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">DISTRACTIONS</div>
                        <div class="stat-value" id="distractionsCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Distraction Parking - COLLAPSED BY DEFAULT -->
            <div class="sidebar-card collapsible">
                <div class="collapsible-header" id="distractionHeader">
                    <h3>üö´ DISTRACTION PARKING</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="collapsible-content collapsed" id="distractionContent">
                    <div class="distraction-count-display" id="distractionCountDisplay">0</div>
                    <div class="distraction-input-col">
                        <input type="text" id="distractionInput" class="distraction-input" placeholder="Park that distraction here...">
                        <label class="checkbox-label">
                            <input type="checkbox" id="handleLaterCheck"> I'll handle this
                        </label>
                        <button class="park-btn" id="parkBtn">PARK IT</button>
                    </div>
                    <div id="microConfirm" class="micro-confirm hidden">Distraction parked</div>
                </div>
            </div>
        </aside>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            sprintCount: 0,
            breaksCount: 0,
            distractionCount: 0,
            sessionState: 'idle',
            tasks: {
                holding: [],
                admin: [],
                deepwork: [],
                strategic: [],
                wins: []
            },
            currentMode: 'balanced',
            energyLevel: 'medium',
            timer: {
                active: false,
                duration: 20,
                remaining: 1200,
                interval: null,
                type: 'focus'
            },
            currentGrade: '-'
        };

        // ============================================
        // INITIALIZATION - CAREFUL WITH AUTH
        // ============================================
        async function init() {
            try {
                // Only check auth if Supabase is configured
                if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    
                    if (!user) {
                        console.log('No user session, redirecting to login');
                        window.location.href = '/start.html';
                        return;
                    }
                    
                    console.log('‚úÖ User authenticated:', user.id);
                    
                    // Try to get/create membership (don't fail if it errors)
                    try {
                        const membership = await getUserMembership();
                        console.log('‚úÖ Membership:', membership ? membership.plan : 'not found');
                    } catch (membershipError) {
                        console.warn('Membership check failed:', membershipError);
                        // Continue anyway - app can work without membership
                    }
                }
            } catch (authError) {
                console.warn('Auth check failed:', authError);
                // Continue anyway - might be in dev mode
            }
            
            // Load app regardless of auth status
            loadState();
            setupEventListeners();
            setupDropZones();
            renderAll();
            console.log('‚úÖ FocusHub initialized');
        }

        // ============================================
        // STATE PERSISTENCE
        // ============================================
        function loadState() {
            const saved = localStorage.getItem('focushub_state');
            if (saved) {
                try {
                    Object.assign(state, JSON.parse(saved));
                } catch (error) {
                    console.error('Error loading state:', error);
                }
            }

            const savedEnergy = localStorage.getItem('focushub_energy');
            if (savedEnergy) {
                state.energyLevel = savedEnergy;
                document.getElementById('energyLevel').value = savedEnergy;
                
                const energyTimers = { low: 15, medium: 20, high: 30 };
                state.timer.duration = energyTimers[savedEnergy];
                state.timer.remaining = state.timer.duration * 60;
                updateTimerButtons();
            }
        }

        function saveState() {
            try {
                localStorage.setItem('focushub_state', JSON.stringify(state));
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Collapsible
            document.getElementById('distractionHeader').addEventListener('click', function() {
                const content = document.getElementById('distractionContent');
                const icon = this.querySelector('.collapse-icon');
                content.classList.toggle('collapsed');
                icon.textContent = content.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            });

            // Timer buttons
            document.querySelectorAll('.timer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timer-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    state.timer.duration = parseInt(this.dataset.duration);
                    state.timer.remaining = state.timer.duration * 60;
                    updateTimerDisplay();
                    saveState();
                });
            });

            // Energy selector
            document.getElementById('energyLevel').addEventListener('change', function() {
                state.energyLevel = this.value;
                localStorage.setItem('focushub_energy', this.value);
                
                const energyTimers = { low: 15, medium: 20, high: 30 };
                state.timer.duration = energyTimers[this.value];
                state.timer.remaining = state.timer.duration * 60;
                updateTimerButtons();
                updateTimerDisplay();
                saveState();
            });

            // Agent mode
            document.getElementById('agentMode').addEventListener('change', function() {
                state.currentMode = this.value;
                saveState();
            });

            // Start sprint
            document.getElementById('startSprintBtn').addEventListener('click', startSprint);

            // Parse tasks
            document.getElementById('parseBtn').addEventListener('click', parseTasks);

            // Park distraction
            document.getElementById('parkBtn').addEventListener('click', parkDistraction);

            // Logout - use Supabase if available
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        if (typeof handleSignout !== 'undefined') {
                            const result = await handleSignout();
                            if (result.success) {
                                localStorage.clear();
                                window.location.href = '/';
                            }
                        } else {
                            // Fallback if Supabase not configured
                            localStorage.clear();
                            window.location.href = '/';
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                        localStorage.clear();
                        window.location.href = '/';
                    }
                }
            });

            // End day
            document.getElementById('endDayBtn').addEventListener('click', endDay);

            // Dashboard
            document.getElementById('dashboardBtn').addEventListener('click', function() {
                window.location.href = '/overview.html';
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }

        // ============================================
        // TASK FUNCTIONS
        // ============================================
        function parseTasks() {
            const input = document.getElementById('taskInput').value.trim();
            if (!input) return;
            
            const tasks = input.split('\n').filter(t => t.trim());
            tasks.forEach(taskText => {
                const task = {
                    id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    text: taskText.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;'),
                    sprints: 1,
                    completed: false,
                    bucket: 'holding'
                };
                state.tasks.holding.push(task);
            });
            
            document.getElementById('taskInput').value = '';
            saveState();
            renderAll();
            showMicroConfirm('Tasks added to holding area');
        }

        function renderTasks() {
            ['holding', 'admin', 'deepwork', 'strategic'].forEach(bucket => {
                const container = document.getElementById(bucket === 'holding' ? 'holdingTasks' : `${bucket}Bucket`);
                const tasks = state.tasks[bucket];
                
                if (tasks.length === 0) {
                    container.innerHTML = bucket === 'holding' 
                        ? '<p class="empty-state">Tasks will appear here</p>'
                        : '<p class="empty-state-small">Drag tasks here</p>';
                } else {
                    container.innerHTML = tasks.map(task => `
                        <div class="task-item" draggable="true" data-task-id="${task.id}" data-bucket="${bucket}">
                            <div class="task-text">${task.text}</div>
                            <div class="task-controls">
                                <button class="task-sprint-btn" onclick="adjustSprints('${task.id}', -1)">-</button>
                                <span class="task-sprints">${task.sprints}</span>
                                <button class="task-sprint-btn" onclick="adjustSprints('${task.id}', 1)">+</button>
                                <button class="task-delete" onclick="deleteTask('${task.id}', '${bucket}')">√ó</button>
                            </div>
                        </div>
                    `).join('');
                    
                    container.querySelectorAll('.task-item').forEach(setupDragAndDrop);
                }
                
                const countEl = document.getElementById(bucket === 'holding' ? 'holdingCount' : `${bucket}Count`);
                if (countEl) countEl.textContent = tasks.length;
            });
        }

        function setupDragAndDrop(taskEl) {
            taskEl.addEventListener('dragstart', function(e) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.dataset.taskId);
                e.dataTransfer.setData('sourceBucket', this.dataset.bucket);
                this.classList.add('dragging');
            });

            taskEl.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
        }

        function setupDropZones() {
            document.querySelectorAll('.task-list').forEach(dropZone => {
                dropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const taskId = e.dataTransfer.getData('text/plain');
                    const sourceBucket = e.dataTransfer.getData('sourceBucket');
                    const targetBucket = this.dataset.bucket;
                    
                    if (sourceBucket === targetBucket) return;
                    
                    moveTask(taskId, sourceBucket, targetBucket);
                });
            });
        }

        function moveTask(taskId, fromBucket, toBucket) {
            const taskIndex = state.tasks[fromBucket].findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = state.tasks[fromBucket].splice(taskIndex, 1)[0];
            task.bucket = toBucket;
            state.tasks[toBucket].push(task);
            
            saveState();
            renderAll();
            showMicroConfirm('Priority updated');
        }

        window.adjustSprints = function(taskId, delta) {
            for (let bucket in state.tasks) {
                const task = state.tasks[bucket].find(t => t.id === taskId);
                if (task) {
                    task.sprints = Math.max(1, Math.min(5, task.sprints + delta));
                    saveState();
                    renderTasks();
                    return;
                }
            }
        };

        window.deleteTask = function(taskId, bucket) {
            state.tasks[bucket] = state.tasks[bucket].filter(t => t.id !== taskId);
            saveState();
            renderAll();
        };

        function endDay() {
            if (confirm('End your day? Uncompleted tasks will move to holding area.')) {
                ['admin', 'deepwork', 'strategic'].forEach(bucket => {
                    state.tasks[bucket].forEach(task => {
                        if (!task.completed) {
                            task.bucket = 'holding';
                            state.tasks.holding.push(task);
                        }
                    });
                    state.tasks[bucket] = [];
                });
                
                saveState();
                window.location.href = '/overview.html';
            }
        }

        // ============================================
        // TIMER FUNCTIONS
        // ============================================
        function startSprint() {
            if (state.timer.active) return;

            state.timer.active = true;
            state.timer.type = 'focus';
            state.sessionState = 'active';
            updateSystemState('Sprint active. Focus mode engaged.');
            
            state.timer.interval = setInterval(() => {
                state.timer.remaining--;
                updateTimerDisplay();
                
                if (state.timer.remaining <= 0) {
                    completeSprint();
                }
            }, 1000);
        }

        function completeSprint() {
            clearInterval(state.timer.interval);
            state.timer.active = false;
            state.sprintCount++;
            state.sessionState = 'idle';
            state.timer.remaining = state.timer.duration * 60;
            
            updateSystemState('Sprint complete. Review task movement before starting another.');
            updateAIMessage('Session logged. System performance updated.');
            
            saveState();
            renderAll();
        }

        function updateTimerButtons() {
            const duration = state.timer.duration;
            document.querySelectorAll('.timer-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.duration) === duration) {
                    btn.classList.add('active');
                }
            });
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timer.remaining / 60);
            const seconds = state.timer.remaining % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const valueEl = document.querySelector('.timer-value');
            const statusEl = document.querySelector('.timer-status');
            
            if (valueEl) valueEl.textContent = timeStr;
            if (statusEl) {
                statusEl.textContent = state.timer.active ? 'In progress' : 'Ready to start';
            }
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function renderAll() {
            document.getElementById('sprintsDone').textContent = state.sprintCount;
            document.getElementById('winsCount').textContent = state.tasks.wins.length;
            document.getElementById('breaksCount').textContent = state.breaksCount;
            document.getElementById('distractionsCount').textContent = state.distractionCount;
            document.getElementById('distractionCountDisplay').textContent = state.distractionCount;
            
            renderTasks();
            updateGrade();
        }

        function updateGrade() {
            const totalSprints = state.sprintCount;
            const target = 5;
            let grade = '-';
            
            if (totalSprints >= target) grade = 'A';
            else if (totalSprints >= target * 0.8) grade = 'B';
            else if (totalSprints >= target * 0.6) grade = 'C';
            else if (totalSprints > 0) grade = 'D';
            
            state.currentGrade = grade;
            document.getElementById('gradeMini').textContent = grade;
        }

        function updateSystemState(message) {
            document.getElementById('systemState').textContent = message;
        }

        function updateAIMessage(message) {
            document.getElementById('aiMessage').textContent = message;
        }

        function showMicroConfirm(message) {
            const el = document.getElementById('microConfirm');
            if (el) {
                el.textContent = message;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 2000);
            }
        }

        function parkDistraction() {
            const input = document.getElementById('distractionInput');
            if (!input.value.trim()) return;
            
            state.distractionCount++;
            input.value = '';
            document.getElementById('handleLaterCheck').checked = false;
            saveState();
            renderAll();
            showMicroConfirm('Distraction parked');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            const logo = document.getElementById('appLogo');
            if (newTheme === 'dark') {
                logo.src = 'FocusHub_horiinv.svg';
                document.getElementById('themeToggle').textContent = 'üåô Dark';
            } else {
                logo.src = 'FocusHub_horinorm.svg';
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light';
            }
            
            localStorage.setItem('focushub_theme', newTheme);
        }

        // ============================================
        // INITIALIZE
        // ============================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Cleanup - FocusHub Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="admin-header-content">
                <div>
                    <img src="FocusHub_horinorm.svg" alt="FocusHub" style="height: 40px; width: auto;">
                    <h1 style="display: inline-block; margin-left: 1rem; font-size: 1.25rem;">‚ö†Ô∏è Database Cleanup Tool</h1>
                </div>
                <div>
                    <a href="admin.html" class="btn btn-secondary">‚Üê Back to Admin</a>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <div class="container" style="max-width: 800px;">
                <div class="admin-section">
                    <h2 style="color: #dc2626;">‚ö†Ô∏è DANGER ZONE</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        This will permanently delete ALL user data from Firestore. 
                        This action <strong>CANNOT BE UNDONE</strong>.
                    </p>
                    
                    <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="color: #dc2626; margin-bottom: 1rem;">What will be deleted:</h3>
                        <ul style="color: #7f1d1d; line-height: 2;">
                            <li>All user profiles</li>
                            <li>All tasks</li>
                            <li>All daily stats</li>
                            <li>All history</li>
                            <li>All distractions</li>
                            <li>All intentions</li>
                            <li>All timer states</li>
                        </ul>
                        <p style="color: #7f1d1d; margin-top: 1rem; font-weight: 600;">
                            Note: Firebase Authentication users must be deleted separately in Firebase Console
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3>Confirmation Required</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Type <code style="background: var(--bg-primary); padding: 0.25rem 0.5rem; border-radius: 4px;">DELETE ALL DATA</code> to confirm:
                        </p>
                        <input type="text" id="confirmText" class="admin-input" placeholder="DELETE ALL DATA" style="margin-bottom: 1rem;">
                        
                        <button id="deleteBtn" onclick="deleteAllData()" class="btn" style="background: #dc2626; color: white; width: 100%;" disabled>
                            üóëÔ∏è Delete All Firestore Data
                        </button>
                    </div>
                    
                    <div id="status" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJeuBD1TSL6gIZnr5sAKvTFYMj66ztzno",
            authDomain: "focushub-91094.firebaseapp.com",
            projectId: "focushub-91094",
            storageBucket: "focushub-91094.firebasestorage.app",
            messagingSenderId: "548003574834",
            appId: "1:548003574834:web:b19ed9ac4d4d84517bb82b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check admin access
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const userDoc = await getDocs(collection(db, 'users'));
            let isAdmin = false;
            
            userDoc.forEach(doc => {
                const data = doc.data();
                if (doc.id === user.uid) {
                    const profileDoc = doc.ref.collection('profile').doc('settings');
                    profileDoc.get().then(profile => {
                        if (profile.exists() && profile.data().plan === 'admin') {
                            isAdmin = true;
                        } else {
                            alert('Access denied. Admin only.');
                            window.location.href = 'admin.html';
                        }
                    });
                }
            });
        });

        // Enable delete button when confirmation text matches
        document.getElementById('confirmText').addEventListener('input', (e) => {
            const deleteBtn = document.getElementById('deleteBtn');
            if (e.target.value === 'DELETE ALL DATA') {
                deleteBtn.disabled = false;
            } else {
                deleteBtn.disabled = true;
            }
        });

        window.deleteAllData = async function() {
            const status = document.getElementById('status');
            const deleteBtn = document.getElementById('deleteBtn');
            
            if (!confirm('Are you ABSOLUTELY SURE? This will delete EVERYTHING and cannot be undone!')) {
                return;
            }
            
            deleteBtn.disabled = true;
            status.innerHTML = '<div style="color: var(--primary-color);">‚è≥ Deleting all data...</div>';
            
            try {
                // Get all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                
                let deleted = 0;
                const total = usersSnapshot.size;
                
                // Delete each user's data
                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    
                    // Delete all subcollections
                    const subcollections = ['profile', 'data'];
                    
                    for (const subcol of subcollections) {
                        const subDocs = await getDocs(collection(db, 'users', userId, subcol));
                        for (const subDoc of subDocs.docs) {
                            await deleteDoc(subDoc.ref);
                        }
                    }
                    
                    deleted++;
                    status.innerHTML = `<div style="color: var(--primary-color);">‚è≥ Deleting... ${deleted}/${total} users</div>`;
                }
                
                status.innerHTML = `
                    <div style="background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 4px; border: 1px solid #10b981;">
                        ‚úÖ Successfully deleted all Firestore data for ${deleted} users!<br><br>
                        <strong>Next steps:</strong><br>
                        1. Go to Firebase Console ‚Üí Authentication<br>
                        2. Delete all user accounts manually<br>
                        3. Then users can sign up fresh
                    </div>
                `;
                
                document.getElementById('confirmText').value = '';
                
            } catch (error) {
                console.error('Error deleting data:', error);
                status.innerHTML = `
                    <div style="background: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 4px; border: 1px solid #dc2626;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                deleteBtn.disabled = false;
            }
        };

        // Theme
        const theme = localStorage.getItem('focushub_theme') || 'light';
        if (theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.querySelector('header img').src = 'FocusHub_horiinv.svg';
        }
    </script>
</body>
</html>

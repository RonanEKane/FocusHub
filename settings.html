<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - FocusHub</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .settings-header {
            margin-bottom: 3rem;
        }

        .settings-header h1 {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .settings-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .settings-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 2px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--industrial-orange);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-light);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .setting-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .setting-control {
            min-width: 250px;
            text-align: right;
        }

        .setting-select,
        .setting-input {
            width: 100%;
            padding: 0.625rem 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-light);
            color: var(--text-primary);
            border-radius: 2px;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }

        .setting-select:focus,
        .setting-input:focus {
            outline: none;
            border-color: var(--industrial-orange);
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--industrial-orange);
            border-color: var(--industrial-orange);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .membership-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--industrial-orange);
            padding: 2rem;
            border-radius: 2px;
            margin-bottom: 2rem;
        }

        .membership-card.premium {
            border-color: var(--industrial-orange);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
        }

        .membership-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--industrial-orange);
            color: #000;
            font-weight: 700;
            font-size: 0.875rem;
            letter-spacing: 1px;
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        .membership-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: var(--industrial-orange);
            border: 2px solid var(--industrial-orange);
            color: #000;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-glow);
            border-color: var(--accent-glow);
            transform: translateY(-1px);
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-light);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--industrial-orange);
            color: var(--industrial-orange);
        }

        .premium-badge {
            color: var(--industrial-orange);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--industrial-orange);
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <a href="app.html" class="back-link">
            ‚Üê Back to App
        </a>

        <div class="settings-header">
            <h1>‚öôÔ∏è Settings</h1>
            <p class="settings-subtitle">Manage your preferences and account</p>
        </div>

        <!-- Membership Status -->
        <div class="membership-card" id="membershipCard">
            <span class="membership-badge" id="membershipBadge">FREE TIER</span>
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">Current Plan</h3>
            <p style="color: var(--text-secondary); margin: 0;">
                Access to core productivity features
            </p>
            <div class="membership-details">
                <span style="color: var(--text-secondary); font-size: 0.875rem;" id="membershipInfo">
                    Free features only
                </span>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn-primary" id="upgradeBtn" onclick="window.location.href='upgrade.html'">
                        ‚≠ê UPGRADE TO PREMIUM
                    </button>
                    <button class="btn-secondary" id="manageSubBtn" onclick="window.location.href='subscription.html'" style="display: none;">
                        üí≥ MANAGE SUBSCRIPTION
                    </button>
                    <button class="btn-secondary" id="adminPanelBtn" onclick="window.location.href='admin.html'" style="display: none;">
                        üõ†Ô∏è ADMIN PANEL
                    </button>
                </div>
            </div>
        </div>

        <!-- Preferences -->
        <div class="settings-section">
            <h2 class="section-title">üé® Preferences</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Theme</div>
                    <div class="setting-description">Choose your preferred color scheme</div>
                </div>
                <div class="setting-control">
                    <select id="themeSelect" class="setting-select">
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">
                        Reflection Tradition
                        <span class="premium-badge" id="reflectionPremiumBadge">üîí PREMIUM</span>
                    </div>
                    <div class="setting-description">Choose your daily reflection source</div>
                </div>
                <div class="setting-control">
                    <select id="reflectionSelect" class="setting-select">
                        <option value="secular">Secular</option>
                        <option value="catholic">Catholic</option>
                        <option value="protestant">Protestant</option>
                        <option value="stoic">Stoic</option>
                        <option value="buddhist">Buddhist</option>
                        <option value="islamic">Islamic</option>
                        <option value="jewish">Jewish</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">
                        AI Intelligence Mode
                        <span class="premium-badge" id="aiPremiumBadge">üîí PREMIUM</span>
                    </div>
                    <div class="setting-description">Intensity level for system feedback (Supportive & Tough require Premium)</div>
                </div>
                <div class="setting-control">
                    <select id="aiModeSelect" class="setting-select">
                        <option value="supportive">Supportive</option>
                        <option value="balanced">Balanced</option>
                        <option value="tough">Tough</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Account -->
        <div class="settings-section">
            <h2 class="section-title">üë§ Account</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Email</div>
                    <div class="setting-description" id="userEmail">Loading...</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Data</div>
                    <div class="setting-description">Clear all local data and start fresh</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="clearAllData()">Clear Data</button>
                </div>
            </div>
        </div>

        <!-- Help -->
        <div class="settings-section">
            <h2 class="section-title">‚ùì Help & Support</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Documentation</div>
                    <div class="setting-description">Learn how to use FocusHub effectively</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="window.open('https://docs.focushub.app', '_blank')">
                        View Docs
                    </button>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Contact Support</div>
                    <div class="setting-description">Get help with any issues</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="window.location.href='mailto:support@focushub.app'">
                        Email Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        // supabaseClient is already created in supabase-config.js
        
        async function init() {
            let userEmail = null;
            let currentPlan = 'free';
            let isAdmin = false;
            
            try {
                // Get current user from Supabase
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (user) {
                    userEmail = user.email;
                    console.log('‚úÖ User logged in:', userEmail);
                    
                    // Check membership in database
                    const { data: membership, error: membershipError } = await supabaseClient
                        .from('memberships')
                        .select('*')
                        .eq('user_id', user.id)
                        .single();
                    
                    if (!membershipError && membership) {
                        currentPlan = membership.plan || 'free';
                        isAdmin = membership.is_admin || false;
                        console.log('‚úÖ Membership loaded:', { plan: currentPlan, isAdmin: isAdmin });
                    } else {
                        console.warn('‚ö†Ô∏è No membership found in database');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No user logged in');
                    // Fallback to localStorage
                    userEmail = localStorage.getItem('focushub_user_email') || 'Not logged in';
                }
            } catch (error) {
                console.error('‚ùå Error loading membership:', error);
                // Fallback to localStorage
                userEmail = localStorage.getItem('focushub_user_email') || 'Error loading user';
                const localMembership = localStorage.getItem('focushub_membership');
                if (localMembership) {
                    try {
                        const data = JSON.parse(localMembership);
                        currentPlan = data.plan || 'free';
                        isAdmin = data.is_admin || false;
                        console.log('‚ö†Ô∏è Using localStorage fallback');
                    } catch (e) {}
                }
            }

            document.getElementById('userEmail').textContent = userEmail;

            // Update UI based on plan
            updateMembershipUI(currentPlan, isAdmin);
            applyFeatureGates(currentPlan, isAdmin);
            loadSettings();
        }

        function updateMembershipUI(plan, isAdmin) {
            const badge = document.getElementById('membershipBadge');
            const info = document.getElementById('membershipInfo');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const manageSubBtn = document.getElementById('manageSubBtn');
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            const card = document.getElementById('membershipCard');

            if (plan === 'premium' || isAdmin) {
                badge.textContent = isAdmin ? 'üëë ADMIN' : '‚≠ê PREMIUM';
                info.textContent = 'Full access to all features';
                upgradeBtn.style.display = 'none';
                manageSubBtn.style.display = isAdmin ? 'none' : 'block'; // Show for premium, hide for admin
                adminPanelBtn.style.display = isAdmin ? 'block' : 'none'; // Show for admin only
                card.classList.add('premium');
            } else {
                badge.textContent = 'FREE TIER';
                info.textContent = 'Upgrade to unlock all features';
                upgradeBtn.style.display = 'block';
                manageSubBtn.style.display = 'none';
                adminPanelBtn.style.display = 'none';
            }
        }

        function applyFeatureGates(plan, isAdmin) {
            const isPremium = plan === 'premium' || isAdmin;

            // Reflection tradition gate
            const reflectionSelect = document.getElementById('reflectionSelect');
            const reflectionBadge = document.getElementById('reflectionPremiumBadge');
            const premiumTraditions = ['catholic', 'protestant', 'stoic', 'buddhist', 'islamic', 'jewish'];
            
            reflectionSelect.querySelectorAll('option').forEach(option => {
                if (premiumTraditions.includes(option.value)) {
                    option.disabled = !isPremium;
                }
            });

            if (isPremium) {
                reflectionBadge.style.display = 'none';
            }

            // AI mode gate
            const aiSelect = document.getElementById('aiModeSelect');
            const aiBadge = document.getElementById('aiPremiumBadge');
            
            aiSelect.querySelector('[value="supportive"]').disabled = !isPremium;
            aiSelect.querySelector('[value="tough"]').disabled = !isPremium;

            if (isPremium) {
                aiBadge.style.display = 'none';
            }
        }

        function loadSettings() {
            // Theme
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            document.getElementById('themeSelect').value = theme;

            // Reflection tradition
            const tradition = localStorage.getItem('focushub_reflection_tradition') || 'secular';
            document.getElementById('reflectionSelect').value = tradition;

            // AI mode
            const state = localStorage.getItem('focushub_state');
            let aiMode = 'balanced';
            if (state) {
                try {
                    const data = JSON.parse(state);
                    aiMode = data.currentMode || 'balanced';
                } catch (e) {}
            }
            document.getElementById('aiModeSelect').value = aiMode;

            // Add change listeners
            document.getElementById('themeSelect').addEventListener('change', handleThemeChange);
            document.getElementById('reflectionSelect').addEventListener('change', handleReflectionChange);
            document.getElementById('aiModeSelect').addEventListener('change', handleAIModeChange);
        }

        function handleThemeChange(e) {
            const theme = e.target.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('focushub_theme', theme);
            showNotification('Theme updated');
        }

        function handleReflectionChange(e) {
            const tradition = e.target.value;
            console.log('Reflection changed to:', tradition);
            
            // Check admin status
            const userEmail = localStorage.getItem('focushub_user_email') || 'watersjb@gmail.com';
            const isAdmin = adminEmails.includes(userEmail);
            
            const membership = localStorage.getItem('focushub_membership');
            let currentPlan = 'free';
            
            if (isAdmin) {
                currentPlan = 'premium';
            } else {
                try {
                    const data = JSON.parse(membership);
                    currentPlan = data.plan || 'free';
                } catch (e) {}
            }

            const premiumTraditions = ['catholic', 'protestant', 'stoic', 'buddhist', 'islamic', 'jewish'];
            
            if (premiumTraditions.includes(tradition) && currentPlan !== 'premium') {
                e.target.value = localStorage.getItem('focushub_reflection_tradition') || 'secular';
                if (confirm('Reflection traditions require Premium. Upgrade now?')) {
                    window.location.href = 'upgrade.html';
                }
                return;
            }

            localStorage.setItem('focushub_reflection_tradition', tradition);
            console.log('Reflection saved:', tradition);
            showNotification(`Reflection tradition set to ${tradition.toUpperCase()}. Takes effect on next day start.`);
        }

        function handleAIModeChange(e) {
            const mode = e.target.value;
            const membership = localStorage.getItem('focushub_membership');
            let currentPlan = 'free';
            
            try {
                const data = JSON.parse(membership);
                currentPlan = data.plan || 'free';
            } catch (e) {}

            if ((mode === 'supportive' || mode === 'tough') && currentPlan !== 'premium') {
                // Load current state
                const state = localStorage.getItem('focushub_state');
                let currentMode = 'balanced';
                if (state) {
                    try {
                        const data = JSON.parse(state);
                        currentMode = data.currentMode || 'balanced';
                    } catch (e) {}
                }
                e.target.value = currentMode;
                
                if (confirm('AI intensity modes require Premium. Upgrade now?')) {
                    window.location.href = 'upgrade.html';
                }
                return;
            }

            // Update state
            const state = localStorage.getItem('focushub_state');
            if (state) {
                try {
                    const data = JSON.parse(state);
                    data.currentMode = mode;
                    localStorage.setItem('focushub_state', JSON.stringify(data));
                    showNotification('AI intensity updated');
                } catch (e) {}
            }
        }

        function clearAllData() {
            if (confirm('Are you sure? This will clear all your tasks, stats, and settings. This cannot be undone.')) {
                localStorage.clear();
                showNotification('Data cleared. Redirecting...');
                setTimeout(() => window.location.href = 'app.html', 1500);
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabaseClient.auth.signOut();
                localStorage.clear();
                window.location.href = '/';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: var(--industrial-orange);
                color: #000;
                padding: 1rem 1.5rem;
                border-radius: 2px;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        init();
    </script>
</body>
</html>

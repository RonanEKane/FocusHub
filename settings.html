<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - FocusHub</title>
    <link rel="stylesheet" href="style.css?v=20.4">
    <style>
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .settings-header {
            margin-bottom: 3rem;
        }

        .settings-header h1 {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .settings-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .settings-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 2px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--industrial-orange);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-light);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .setting-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .setting-control {
            min-width: 250px;
            text-align: right;
        }

        .setting-select,
        .setting-input {
            width: 100%;
            padding: 0.625rem 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-light);
            color: var(--text-primary);
            border-radius: 2px;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
        }

        .setting-select:focus,
        .setting-input:focus {
            outline: none;
            border-color: var(--industrial-orange);
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--industrial-orange);
            border-color: var(--industrial-orange);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .membership-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--industrial-orange);
            padding: 2rem;
            border-radius: 2px;
            margin-bottom: 2rem;
        }

        .membership-card.premium {
            border-color: var(--industrial-orange);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
        }

        .membership-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--industrial-orange);
            color: #000;
            font-weight: 700;
            font-size: 0.875rem;
            letter-spacing: 1px;
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        .membership-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: var(--industrial-orange);
            border: 2px solid var(--industrial-orange);
            color: #000;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-glow);
            border-color: var(--accent-glow);
            transform: translateY(-1px);
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-light);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--industrial-orange);
            color: var(--industrial-orange);
        }

        .premium-badge {
            color: var(--industrial-orange);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--industrial-orange);
        }
        
        /* VERSION SELECTOR STYLES */
        .current-plan {
            background: var(--bg-primary);
            border: 2px solid var(--industrial-orange);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .plan-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .plan-badge.lite {
            background: #666;
            color: white;
        }
        
        .plan-badge.student {
            background: var(--industrial-orange);
            color: white;
        }
        
        .plan-badge.premium {
            background: linear-gradient(135deg, #f55b07 0%, #ff8c42 100%);
            color: white;
        }
        
        .plan-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .version-options {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .version-option {
            background: var(--bg-primary);
            border: 2px solid var(--border-light);
            border-radius: 4px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .version-option:hover {
            border-color: var(--industrial-orange);
            background: var(--bg-elevated);
        }
        
        .version-option.selected {
            border-color: var(--industrial-orange);
            background: rgba(245, 91, 7, 0.1);
        }
        
        .version-option-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .version-icon {
            font-size: 1.5rem;
        }
        
        .version-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .version-price {
            margin-left: auto;
            font-weight: 700;
            color: var(--industrial-orange);
        }
        
        .version-features {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <a href="app.html" class="back-link">
            ‚Üê Back to App
        </a>

        <div class="settings-header">
            <h1>‚öôÔ∏è Settings</h1>
            <p class="settings-subtitle">Manage your preferences and account</p>
        </div>

        <!-- Membership Status -->
        <div class="membership-card" id="membershipCard">
            <span class="membership-badge" id="membershipBadge">FREE TIER</span>
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">Current Plan</h3>
            <p style="color: var(--text-secondary); margin: 0;">
                Access to core productivity features
            </p>
            <div class="membership-details">
                <span style="color: var(--text-secondary); font-size: 0.875rem;" id="membershipInfo">
                    Free features only
                </span>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn-primary" id="upgradeBtn" onclick="window.location.href='upgrade.html'">
                        ‚≠ê UPGRADE TO PREMIUM
                    </button>
                    <button class="btn-secondary" id="manageSubBtn" onclick="window.location.href='subscription.html'" style="display: none;">
                        üí≥ MANAGE SUBSCRIPTION
                    </button>
                    <button class="btn-secondary" id="adminPanelBtn" onclick="window.location.href='admin.html'" style="display: none;">
                        üõ†Ô∏è ADMIN PANEL
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Type / Version -->
        <div class="settings-section">
            <h2 class="section-title">üí≥ Account Type</h2>
            
            <div class="current-plan">
                <div class="plan-badge student" id="currentPlanBadge">üéì Student</div>
                <p class="plan-description" id="currentPlanDescription">Session-based tracking ‚Ä¢ $9/month</p>
                <button class="btn-secondary" onclick="toggleVersionSelector()">Change Plan</button>
            </div>
            
            <div class="version-options" id="versionOptions" style="display: none;">
                <div class="version-option" data-version="lite" onclick="selectVersion('lite')">
                    <div class="version-option-header">
                        <span class="version-icon">üÜì</span>
                        <span class="version-name">Lite</span>
                        <span class="version-price">Free</span>
                    </div>
                    <div class="version-features">
                        Unlimited sprints ‚Ä¢ Basic analytics ‚Ä¢ General reflections
                    </div>
                </div>
                
                <div class="version-option selected" data-version="student" onclick="selectVersion('student')">
                    <div class="version-option-header">
                        <span class="version-icon">üéì</span>
                        <span class="version-name">Student</span>
                        <span class="version-price">$9/month</span>
                    </div>
                    <div class="version-features">
                        Session-based tracking ‚Ä¢ Student coaching ‚Ä¢ Choose reflection traditions ‚Ä¢ Supabase sync
                    </div>
                </div>
                
                <div class="version-option" data-version="premium" onclick="selectVersion('premium')">
                    <div class="version-option-header">
                        <span class="version-icon">üíº</span>
                        <span class="version-name">Premium</span>
                        <span class="version-price">$19/month</span>
                    </div>
                    <div class="version-features">
                        Everything in Student ‚Ä¢ Meeting mode ‚Ä¢ Full analytics ‚Ä¢ Weekly reports ‚Ä¢ Data export
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences -->
        <div class="settings-section">
            <h2 class="section-title">üé® Preferences</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Theme</div>
                    <div class="setting-description">Choose your preferred color scheme</div>
                </div>
                <div class="setting-control">
                    <select id="themeSelect" class="setting-select">
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">
                        Reflection Tradition
                        <span class="premium-badge" id="reflectionPremiumBadge" style="display: none;">üîí LITE ONLY: GENERAL</span>
                    </div>
                    <div class="setting-description">Choose your daily reflection source (Student & Premium)</div>
                </div>
                <div class="setting-control">
                    <select id="reflectionSelect" class="setting-select">
                        <option value="secular">Secular / Humanist</option>
                        <option value="catholic">Catholic</option>
                        <option value="protestant">Protestant</option>
                        <option value="stoic">Stoic</option>
                        <option value="buddhist">Buddhist</option>
                        <option value="islamic">Islamic</option>
                        <option value="jewish">Jewish</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">
                        AI Intelligence Mode
                        <span class="premium-badge" id="aiPremiumBadge">üîí PREMIUM</span>
                    </div>
                    <div class="setting-description">Intensity level for system feedback (Supportive & Tough require Premium)</div>
                </div>
                <div class="setting-control">
                    <select id="aiModeSelect" class="setting-select">
                        <option value="supportive">Supportive</option>
                        <option value="balanced">Balanced</option>
                        <option value="tough">Tough</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Account -->
        <div class="settings-section">
            <h2 class="section-title">üë§ Account</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Email</div>
                    <div class="setting-description" id="userEmail">Loading...</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Data</div>
                    <div class="setting-description">Clear all local data and start fresh</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="clearAllData()">Clear Data</button>
                </div>
            </div>
        </div>

        <!-- Help -->
        <div class="settings-section">
            <h2 class="section-title">‚ùì Help & Support</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Documentation</div>
                    <div class="setting-description">Learn how to use FocusHub effectively</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="window.open('https://docs.focushub.app', '_blank')">
                        View Docs
                    </button>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <div class="setting-label">Contact Support</div>
                    <div class="setting-description">Get help with any issues</div>
                </div>
                <div class="setting-control">
                    <button class="btn-secondary" onclick="window.location.href='faq.html'">
                        üí¨ AI Support Chat
                    </button>
                </div>
            </div>
            
            <div class="setting-row" style="border-top: 2px solid var(--industrial-orange); padding-top: 1.5rem; margin-top: 1rem;">
                <div class="setting-info">
                    <div class="setting-label">üß™ Beta Feedback</div>
                    <div class="setting-description">Report bugs, suggest features, or share your experience</div>
                </div>
                <div class="setting-control">
                    <button class="btn btn-primary" onclick="document.getElementById('feedbackModal').style.display='flex'">
                        Share Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Beta Feedback Modal -->
    <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 2rem;">
        <div style="background: var(--bg-primary); border: 2px solid var(--industrial-orange); border-radius: 8px; max-width: 600px; width: 100%; padding: 2rem; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: var(--industrial-orange); margin-bottom: 1rem; font-size: 1.5rem;">Beta Feedback</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Your input helps make FocusHub better for everyone with ADHD.</p>
            
            <form id="betaFeedbackForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Feedback Type</label>
                    <select id="feedbackType" style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-primary); font-family: inherit;">
                        <option value="bug">üêõ Bug Report</option>
                        <option value="feature">üí° Feature Request</option>
                        <option value="improvement">‚ú® Improvement Suggestion</option>
                        <option value="praise">üëè Something I Love</option>
                        <option value="other">üí¨ Other</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Your Message</label>
                    <textarea id="feedbackMessage" rows="6" placeholder="Tell us what's on your mind..." style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-primary); font-family: inherit; resize: vertical;" required></textarea>
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Email (optional)</label>
                    <input type="email" id="feedbackEmail" placeholder="your@email.com" style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-primary); font-family: inherit;">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">If you'd like us to follow up with you</p>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Feedback</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('feedbackModal').style.display='none'; document.getElementById('betaFeedbackForm').reset();" style="flex: 1;">Cancel</button>
                </div>
            </form>
            
            <div id="feedbackSuccess" style="display: none; text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="color: var(--industrial-orange); margin-bottom: 0.5rem;">Thank You!</h3>
                <p style="color: var(--text-secondary);">Your feedback has been submitted. We read every message.</p>
                <button class="btn btn-primary" onclick="document.getElementById('feedbackModal').style.display='none'; document.getElementById('feedbackSuccess').style.display='none'; document.getElementById('betaFeedbackForm').style.display='flex'; document.getElementById('betaFeedbackForm').reset();" style="margin-top: 1rem;">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        // supabaseClient is already created in supabase-config.js
        
        async function init() {
            let userEmail = null;
            let currentPlan = 'free';
            let isAdmin = false;
            
            try {
                // Get current user from Supabase
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (user) {
                    userEmail = user.email;
                    console.log('‚úÖ User logged in:', userEmail);
                    
                    // Check membership in database
                    const { data: membership, error: membershipError } = await supabaseClient
                        .from('memberships')
                        .select('*')
                        .eq('user_id', user.id)
                        .single();
                    
                    if (!membershipError && membership) {
                        currentPlan = membership.plan || 'free';
                        isAdmin = membership.is_admin || false;
                        console.log('‚úÖ Membership loaded:', { plan: currentPlan, isAdmin: isAdmin });
                        
                        // Save to localStorage for other functions to access
                        localStorage.setItem('focushub_membership', JSON.stringify({
                            plan: currentPlan,
                            is_admin: isAdmin
                        }));
                    } else {
                        console.warn('‚ö†Ô∏è No membership found in database');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No user logged in');
                    // Fallback to localStorage
                    userEmail = localStorage.getItem('focushub_user_email') || 'Not logged in';
                }
            } catch (error) {
                console.error('‚ùå Error loading membership:', error);
                // Fallback to localStorage
                userEmail = localStorage.getItem('focushub_user_email') || 'Error loading user';
                const localMembership = localStorage.getItem('focushub_membership');
                if (localMembership) {
                    try {
                        const data = JSON.parse(localMembership);
                        currentPlan = data.plan || 'free';
                        isAdmin = data.is_admin || false;
                        console.log('‚ö†Ô∏è Using localStorage fallback');
                    } catch (e) {}
                }
            }

            document.getElementById('userEmail').textContent = userEmail;

            // Update UI based on plan
            updateMembershipUI(currentPlan, isAdmin);
            applyFeatureGates(currentPlan, isAdmin);
            loadSettings();
        }

        function updateMembershipUI(plan, isAdmin) {
            const badge = document.getElementById('membershipBadge');
            const info = document.getElementById('membershipInfo');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const manageSubBtn = document.getElementById('manageSubBtn');
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            const card = document.getElementById('membershipCard');

            if (plan === 'premium' || isAdmin) {
                badge.textContent = isAdmin ? 'üëë ADMIN' : '‚≠ê PREMIUM';
                info.textContent = 'Full access to all features';
                upgradeBtn.style.display = 'none';
                manageSubBtn.style.display = isAdmin ? 'none' : 'block'; // Show for premium, hide for admin
                adminPanelBtn.style.display = isAdmin ? 'block' : 'none'; // Show for admin only
                card.classList.add('premium');
            } else {
                badge.textContent = 'FREE TIER';
                info.textContent = 'Upgrade to unlock all features';
                upgradeBtn.style.display = 'block';
                manageSubBtn.style.display = 'none';
                adminPanelBtn.style.display = 'none';
            }
        }

        function applyFeatureGates(plan, isAdmin) {
            const isPremium = plan === 'premium' || isAdmin;

            // Reflection tradition gate
            const reflectionSelect = document.getElementById('reflectionSelect');
            const reflectionBadge = document.getElementById('reflectionPremiumBadge');
            const premiumTraditions = ['catholic', 'protestant', 'stoic', 'buddhist', 'islamic', 'jewish'];
            
            reflectionSelect.querySelectorAll('option').forEach(option => {
                if (premiumTraditions.includes(option.value)) {
                    option.disabled = !isPremium;
                }
            });

            if (isPremium) {
                reflectionBadge.style.display = 'none';
            }

            // AI mode gate
            const aiSelect = document.getElementById('aiModeSelect');
            const aiBadge = document.getElementById('aiPremiumBadge');
            
            aiSelect.querySelector('[value="supportive"]').disabled = !isPremium;
            aiSelect.querySelector('[value="tough"]').disabled = !isPremium;

            if (isPremium) {
                aiBadge.style.display = 'none';
            }
        }

        function loadSettings() {
            // Theme
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            document.getElementById('themeSelect').value = theme;

            // Reflection tradition
            const tradition = localStorage.getItem('focushub_reflection_tradition') || 'secular';
            document.getElementById('reflectionSelect').value = tradition;

            // AI mode
            const state = localStorage.getItem('focushub_state');
            let aiMode = 'balanced';
            if (state) {
                try {
                    const data = JSON.parse(state);
                    aiMode = data.currentMode || 'balanced';
                } catch (e) {}
            }
            document.getElementById('aiModeSelect').value = aiMode;

            // Add change listeners
            document.getElementById('themeSelect').addEventListener('change', handleThemeChange);
            document.getElementById('reflectionSelect').addEventListener('change', handleReflectionChange);
            document.getElementById('aiModeSelect').addEventListener('change', handleAIModeChange);
        }

        function handleThemeChange(e) {
            const theme = e.target.value;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('focushub_theme', theme);
            showNotification('Theme updated');
        }

        function handleReflectionChange(e) {
            const tradition = e.target.value;
            console.log('Reflection changed to:', tradition);
            
            // Check if user has premium/admin access
            let currentPlan = 'free';
            let isAdmin = false;
            
            if (typeof isAdminUser !== 'undefined') {
                isAdmin = isAdminUser; // From init function
                currentPlan = isAdmin ? 'premium' : currentPlan;
            }
            
            if (!isAdmin) {
                const membership = localStorage.getItem('focushub_membership');
                try {
                    const data = JSON.parse(membership);
                    currentPlan = data.plan || 'free';
                    isAdmin = data.is_admin || false;
                } catch (e) {}
            }

            const premiumTraditions = ['catholic', 'protestant', 'stoic', 'buddhist', 'islamic', 'jewish'];
            
            if (premiumTraditions.includes(tradition) && currentPlan !== 'premium' && !isAdmin) {
                e.target.value = localStorage.getItem('focushub_reflection_tradition') || 'secular';
            }

            // Check again for upgrade prompt
            if (premiumTraditions.includes(tradition) && currentPlan !== 'premium') {
                e.target.value = localStorage.getItem('focushub_reflection_tradition') || 'secular';
                if (confirm('Reflection traditions require Premium. Upgrade now?')) {
                    window.location.href = 'upgrade.html';
                }
                return;
            }

            localStorage.setItem('focushub_reflection_tradition', tradition);
            console.log('Reflection saved:', tradition);
            showNotification(`Reflection tradition set to ${tradition.toUpperCase()}. Takes effect on next day start.`);
        }

        function handleAIModeChange(e) {
            const mode = e.target.value;
            
            // AI INTENSITY IS FREE FOR EVERYONE - No premium check needed!
            // Users can change this on app.html anyway, so no reason to gate it here
            
            // Update state
            const state = localStorage.getItem('focushub_state');
            if (state) {
                try {
                    const data = JSON.parse(state);
                    data.currentMode = mode;
                    localStorage.setItem('focushub_state', JSON.stringify(data));
                    showNotification('AI intensity updated');
                } catch (e) {}
            }
        }

        function clearAllData() {
            if (confirm('Are you sure? This will clear all your tasks, stats, and settings. This cannot be undone.')) {
                localStorage.clear();
                showNotification('Data cleared. Redirecting...');
                setTimeout(() => window.location.href = 'app.html', 1500);
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabaseClient.auth.signOut();
                localStorage.clear();
                window.location.href = '/';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: var(--industrial-orange);
                color: #000;
                padding: 1rem 1.5rem;
                border-radius: 2px;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Beta Feedback Form Handler
        document.getElementById('betaFeedbackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const message = document.getElementById('feedbackMessage').value;
            const email = document.getElementById('feedbackEmail').value;
            
            try {
                // Get current user email from Supabase
                const { data: { user } } = await supabaseClient.auth.getUser();
                const userEmail = user?.email || email || 'anonymous';
                
                // Save feedback to Supabase
                const { error } = await supabaseClient
                    .from('beta_feedback')
                    .insert({
                        user_id: user?.id || null,
                        feedback_type: type,
                        message: message,
                        contact_email: email || userEmail,
                        user_agent: navigator.userAgent,
                        created_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('Feedback submission error:', error);
                    // Fallback: log to console for now
                    console.log('BETA FEEDBACK:', { type, message, email: userEmail });
                }
                
                // Show success message
                document.getElementById('betaFeedbackForm').style.display = 'none';
                document.getElementById('feedbackSuccess').style.display = 'block';
                
            } catch (err) {
                console.error('Feedback error:', err);
                // Still show success to user
                document.getElementById('betaFeedbackForm').style.display = 'none';
                document.getElementById('feedbackSuccess').style.display = 'block';
            }
        });

        // ============================================
        // VERSION SELECTOR
        // ============================================
        
        function toggleVersionSelector() {
            const options = document.getElementById('versionOptions');
            options.style.display = options.style.display === 'none' ? 'grid' : 'none';
        }
        
        function selectVersion(version) {
            // Update selected state
            document.querySelectorAll('.version-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-version="${version}"]`).classList.add('selected');
            
            // Update membership
            const membership = {
                version: version,
                tier: version === 'lite' ? 'free' : version,
                updated_at: new Date().toISOString()
            };
            
            localStorage.setItem('focushub_membership', JSON.stringify(membership));
            
            // Update display
            updateVersionDisplay(version);
            
            // Hide options
            document.getElementById('versionOptions').style.display = 'none';
            
            // Update reflection tradition access
            updateReflectionAccess(version);
            
            // Show confirmation
            alert(`Plan changed to ${getVersionName(version)}. Refresh the app to apply changes.`);
        }
        
        function updateVersionDisplay(version) {
            const badge = document.getElementById('currentPlanBadge');
            const description = document.getElementById('currentPlanDescription');
            
            const versionData = {
                lite: {
                    badge: 'üÜì Lite',
                    description: 'Free ‚Ä¢ Basic features',
                    class: 'lite'
                },
                student: {
                    badge: 'üéì Student',
                    description: 'Session-based tracking ‚Ä¢ $9/month',
                    class: 'student'
                },
                premium: {
                    badge: 'üíº Premium',
                    description: 'Full features ‚Ä¢ $19/month',
                    class: 'premium'
                }
            };
            
            const data = versionData[version];
            badge.textContent = data.badge;
            badge.className = `plan-badge ${data.class}`;
            description.textContent = data.description;
        }
        
        function getVersionName(version) {
            const names = { lite: 'Lite', student: 'Student', premium: 'Premium' };
            return names[version] || version;
        }
        
        function updateReflectionAccess(version) {
            const reflectionBadge = document.getElementById('reflectionPremiumBadge');
            const reflectionSelect = document.getElementById('reflectionSelect');
            
            if (version === 'lite') {
                reflectionBadge.style.display = 'inline';
                reflectionSelect.disabled = true;
                reflectionSelect.value = 'secular';
            } else {
                reflectionBadge.style.display = 'none';
                reflectionSelect.disabled = false;
            }
        }
        
        function initializeVersionDisplay() {
            try {
                const membership = localStorage.getItem('focushub_membership');
                let version = 'lite';
                
                if (membership) {
                    const data = JSON.parse(membership);
                    version = data.version || data.tier || 'lite';
                }
                
                updateVersionDisplay(version);
                updateReflectionAccess(version);
                
                // Update selected option
                document.querySelectorAll('.version-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                const selected = document.querySelector(`[data-version="${version}"]`);
                if (selected) selected.classList.add('selected');
                
            } catch (e) {
                console.error('Error initializing version display:', e);
            }
        }
        
        // Initialize version display
        initializeVersionDisplay();

        init();
    </script>
</body>
</html>

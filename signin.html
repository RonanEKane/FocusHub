<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - FocusHub</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <img src="FocusHub_vertnorm.svg" alt="FocusHub" class="auth-logo" style="height: 60px; width: auto; margin: 0 auto 2rem; display: block;">
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>Welcome Back</h2>
                <p class="auth-subtitle">Sign in to continue your productivity journey</p>
                
                <form id="loginFormElement" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    
                    <div id="loginError" class="auth-error hidden"></div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Sign In</button>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="#" onclick="showPasswordReset(); return false;" style="font-size: 0.875rem; color: var(--primary-color);">Forgot password?</a>
                    </div>
                </form>
                
                <p class="auth-switch">
                    Don't have an account? 
                    <a href="#" onclick="showSignup(); return false;">Sign up</a>
                </p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form hidden">
                <h2>Get Started</h2>
                <p class="auth-subtitle">Create your account and choose your mode</p>
                
                <form id="signupFormElement" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required minlength="6">
                        <small style="color: var(--text-muted);">Minimum 6 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Your Mode</label>
                        <select id="modeSelect" class="mode-select" required>
                            <option value="free">Free - Core Features</option>
                            <option value="tough_love">Tough Love ($9/mo) - Aggressive Accountability</option>
                            <option value="zen_mode">Zen Mode ($9/mo) - Gentle Guidance</option>
                            <option value="college">College Student ($4/mo) - Student Discount</option>
                            <option value="high_school">High School ($2/mo) - Teen Pricing</option>
                        </select>
                    </div>
                    
                    <div id="signupError" class="auth-error hidden"></div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="signupBtn">Create Account</button>
                </form>
                
                <p class="auth-switch">
                    Already have an account? 
                    <a href="#" onclick="showLogin(); return false;">Sign in</a>
                </p>
            </div>
            
            <!-- Password Reset Form -->
            <div id="resetForm" class="auth-form hidden">
                <h2>Reset Password</h2>
                <p class="auth-subtitle">Enter your email to receive a password reset link</p>
                
                <form id="resetFormElement" onsubmit="handlePasswordReset(event)">
                    <div class="form-group">
                        <label for="resetEmail">Email</label>
                        <input type="email" id="resetEmail" required>
                    </div>
                    
                    <div id="resetError" class="auth-error hidden"></div>
                    <div id="resetSuccess" class="auth-success hidden"></div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="resetBtn">Send Reset Link</button>
                </form>
                
                <p class="auth-switch">
                    <a href="#" onclick="showLogin(); return false;">‚Üê Back to Sign In</a>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJeuBD1TSL6gIZnr5sAKvTFYMj66ztzno",
            authDomain: "focushub-91094.firebaseapp.com",
            projectId: "focushub-91094",
            storageBucket: "focushub-91094.firebasestorage.app",
            messagingSenderId: "548003574834",
            appId: "1:548003574834:web:b19ed9ac4d4d84517bb82b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make functions available globally
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.showPasswordReset = showPasswordReset;
        window.handlePasswordReset = handlePasswordReset;

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('resetForm').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('signupError').classList.add('hidden');
        }
        
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('resetForm').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('signupError').classList.add('hidden');
        }
        
        function showPasswordReset() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('resetForm').classList.remove('hidden');
            document.getElementById('resetError').classList.add('hidden');
            document.getElementById('resetSuccess').classList.add('hidden');
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            errorEl.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Redirect to app
                window.location.href = 'app.html';
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = getErrorMessage(error.code);
                errorEl.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }
        
        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const mode = document.getElementById('modeSelect').value;
            const errorEl = document.getElementById('signupError');
            const btn = document.getElementById('signupBtn');
            
            btn.disabled = true;
            btn.textContent = 'Creating account...';
            errorEl.classList.add('hidden');
            
            try {
                // Create user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Determine plan type
                let plan = 'free';
                if (email === 'watersjb@gmail.com') {
                    plan = 'admin';
                } else if (mode !== 'free') {
                    plan = mode;
                }
                
                // Create user profile in Firestore
                await setDoc(doc(db, 'users', user.uid, 'profile', 'settings'), {
                    email: email,
                    plan: plan,
                    mode: mode,
                    createdAt: new Date().toISOString(),
                    toughLoveLevel: mode === 'tough_love' ? 'aggressive' : mode === 'zen_mode' ? 'gentle' : 'balanced'
                });
                
                // Redirect to app
                window.location.href = 'app.html';
            } catch (error) {
                console.error('Signup error:', error);
                errorEl.textContent = getErrorMessage(error.code);
                errorEl.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }
        
        async function handlePasswordReset(event) {
            event.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const errorEl = document.getElementById('resetError');
            const successEl = document.getElementById('resetSuccess');
            const btn = document.getElementById('resetBtn');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');
            
            try {
                await sendPasswordResetEmail(auth, email);
                successEl.textContent = 'Password reset email sent! Check your inbox.';
                successEl.classList.remove('hidden');
                document.getElementById('resetEmail').value = '';
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            } catch (error) {
                console.error('Password reset error:', error);
                errorEl.textContent = getErrorMessage(error.code);
                errorEl.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        }
        
        function getErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/user-disabled':
                    return 'This account has been disabled.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/email-already-in-use':
                    return 'An account already exists with this email.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }
        
        // Theme detection
        function initTheme() {
            const theme = localStorage.getItem('focushub_theme') || 'light';
            const authLogo = document.querySelector('.auth-logo');
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                authLogo.src = 'FocusHub_vertdark.svg';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                authLogo.src = 'FocusHub_vertnorm.svg';
            }
        }
        
        initTheme();
    </script>
</body>
</html>

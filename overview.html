<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mission Control - FocusHub</title>
    <link rel="stylesheet" href="style.css?v=20.4">
</head>
<body>
    <!-- Technical Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <img id="dashboardLogo" src="FocusHub_vertinv.svg" alt="FocusHub" class="status-logo" style="height: 80px; width: auto;">
        </div>
        <div class="status-middle">
            <div id="dashboardTimer" class="dashboard-timer hidden">
                <span class="timer-icon">‚è±</span>
                <span id="dashboardTimerText">00:00</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span class="status-text">SYSTEM STATUS: ONLINE</span>
            </div>
            <div class="status-time" id="currentTime"></div>
            <a href="admin.html" id="adminLink" class="btn-home hidden" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--primary-color); font-weight: 600; font-size: 0.875rem; text-decoration: none;">üõ†Ô∏è Admin</a>
            <button id="logoutBtn" class="btn-home" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem;">Logout</button>
        </div>
    </div>

    <!-- Admin Impersonation Banner -->
    <div id="impersonationBanner" class="impersonation-banner hidden">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <span>üëÅÔ∏è <strong>Viewing as:</strong> <span id="impersonatedEmail"></span></span>
            <button onclick="returnToAdmin()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Return to Admin</button>
        </div>
    </div>

    <!-- Mission Control Dashboard -->
    <div class="mission-control">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h1 class="mission-title" data-label="missionControl">MISSION CONTROL</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="mode-indicator" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 0.875rem; color: var(--text-secondary); padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px;">
                    MODE: <span id="currentMode" style="color: var(--text-primary); font-weight: 600;">LOADING...</span>
                </div>
                    <div id="tierBadge" class="tier-badge" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 0.875rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; display: flex; align-items: center; gap: 0.5rem;">
                        <span id="tierEmoji">üí°</span>
                        <span id="tierName" style="font-weight: 600; color: var(--text-primary);">LITE</span>
                    </div>
                    <button onclick="window.WeeklyReports?.showReport()" class="btn btn-secondary" style="font-size: 0.875rem;">üìä Report</button>
                    <a href="upgrade.html" id="upgradeBtn" class="btn btn-primary hidden" style="font-size: 0.875rem;">‚ú® Upgrade</a>
                </div>
            </div>
            
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 2rem;">Overview of recent focus performance.</p>
            
            <!-- Bento Grid -->
            <div class="bento-grid">
                <!-- Empty State (shown when no sessions) -->
                <div id="overviewEmptyState" class="bento-card" style="grid-column: 1 / -1; display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üìä</div>
                    <h3 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5rem;">No sessions recorded.</h3>
                    <p style="color: var(--text-secondary); margin: 0;">Sessions appear here once completed.</p>
                </div>
                
                <!-- Total Sprints -->
                <div class="bento-card activity-flow">
                    <div class="card-micro-label">LIVE_TICKER_01</div>
                    <h3 class="card-title">Activity Flow</h3>
                    <div class="activity-chart">
                        <div class="metric-large" id="totalSprints">0</div>
                        <div class="metric-label">Total Sprints</div>
                    </div>
                    <div class="activity-context">
                        Total: <span id="totalSprintsContext">0</span> <span style="color: var(--text-secondary); font-size: 0.875rem;">(Last 7 days)</span>
                    </div>
                </div>

                <!-- Day Streak -->
                <div class="bento-card consistency-log">
                    <div class="card-micro-label">STREAK_TRACKER</div>
                    <h3 class="card-title">Consistency Log</h3>
                    <div class="consistency-chart">
                        <div class="metric-large" id="dayStreak">0</div>
                        <div class="metric-label">Day Streak (B+ or Higher)</div>
                    </div>
                    <div class="bar-chart-mini" id="weeklyChart"></div>
                </div>

                <!-- Focus Score -->
                <div class="bento-card daily-score">
                    <div class="card-micro-label">PERF_INDEX</div>
                    <h3 class="card-title">Performance Index</h3>
                    <div class="score-gauge">
                        <div class="gauge-value" id="focusScore">0%</div>
                        <div class="gauge-label">Avg Grade: <span id="avgGrade">N/A</span></div>
                    </div>
                    <div class="score-context">
                        Tasks Completed: <span class="streak-value" id="totalTasks">0</span>
                    </div>
                </div>

                <!-- NEW: Intention vs. Reality -->
                <div class="bento-card intention-reality">
                    <div class="card-micro-label">BEHAVIOR_DELTA</div>
                    <h3 class="card-title">Intention vs. Reality</h3>
                    <div class="intention-visual">
                        <div class="intention-bar">
                            <div class="intention-fill" id="intentionFill" style="width: 0%"></div>
                            <div class="intention-label">What You Said</div>
                        </div>
                        <div class="reality-bar">
                            <div class="reality-fill" id="realityFill" style="width: 0%"></div>
                            <div class="reality-label">What You Did</div>
                        </div>
                    </div>
                    <div class="intention-stats">
                        <div class="stat-item">
                            <span class="stat-num" id="intentionCount">0</span>
                            <span class="stat-desc">Declared Intentions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num" id="realityCount">0</span>
                            <span class="stat-desc">Followed Through</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Action -->
            <button class="primary-action" onclick="window.location.href='app.html'">
                <span class="action-icon">[ &gt; ]</span>
                <span class="action-text">RETURN TO WORKSPACE</span>
            </button>

            <!-- Quick Stats Table -->
            <div class="stats-table">
                <h3 class="stats-title">SYSTEM METRICS</h3>
                <table>
                    <tr>
                        <td class="stat-label">Days Logged</td>
                        <td class="stat-value" id="daysLogged">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Average Distractions/Day</td>
                        <td class="stat-value" id="avgDistractions">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Sprint Completion Rate</td>
                        <td class="stat-value" id="sprintRate">0%</td>
                    </tr>
                </table>
            </div>
            
            <!-- Grade History Section -->
            <div class="stats-table" style="margin-top: 2rem;">
                <h3 class="stats-title">üìä GRADE HISTORY</h3>
                <div id="gradeHistoryContent" style="margin-top: 1rem;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <!-- Subject Breakdown (Student Mode Only) -->
            <div id="subjectBreakdownSection" class="stats-table hidden" style="margin-top: 2rem;">
                <h3 class="stats-title">üìö SUBJECT BREAKDOWN</h3>
                <div id="subjectBreakdown" class="subject-breakdown-content">
                    <!-- Populated by JavaScript -->
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-top: 1rem;">
                    Based on completed tasks
                </p>
            </div>
            
            <!-- Premium Historical Analytics -->
            <div id="premiumAnalyticsSection" class="stats-table hidden" style="margin-top: 3rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 class="stats-title">üìà HISTORICAL ANALYTICS</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="exportAnalytics()" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.5rem 1rem;">üì• Export CSV</button>
                        <span style="font-size: 0.75rem; color: var(--industrial-orange); font-weight: 600; padding: 0.25rem 0.75rem; background: rgba(245, 91, 7, 0.1); border-radius: 4px;">‚≠ê PREMIUM</span>
                    </div>
                </div>
                
                <!-- Time Period Selector -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button onclick="loadAnalyticsPeriod(30)" id="period30" class="period-btn active">30 Days</button>
                    <button onclick="loadAnalyticsPeriod(60)" id="period60" class="period-btn">60 Days</button>
                    <button onclick="loadAnalyticsPeriod(90)" id="period90" class="period-btn">90 Days</button>
                    <button onclick="loadAnalyticsPeriod(0)" id="periodAll" class="period-btn">All Time</button>
                </div>
                
                <!-- Analytics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <!-- Productivity Trend -->
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">üìä Productivity Trend</h4>
                        <div id="trendChart" style="height: 200px; background: var(--bg-secondary); border-radius: 8px; padding: 1rem; position: relative;">
                            <canvas id="trendCanvas" width="100%" height="100%"></canvas>
                        </div>
                        <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                            Week-over-week grade performance
                        </p>
                    </div>
                    
                    <!-- Peak Performance -->
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">‚è∞ Peak Performance</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td class="stat-label">Best Day of Week</td>
                                <td class="stat-value" id="bestDayOfWeek">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Most Productive Hour</td>
                                <td class="stat-value" id="bestHour">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Avg Sprints/Day</td>
                                <td class="stat-value" id="avgSprintsPerDay">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Sprint Completion Rate</td>
                                <td class="stat-value" id="sprintCompletionRate">-</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Task Patterns -->
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">üìã Task Patterns</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td class="stat-label">Tasks Completed</td>
                                <td class="stat-value" id="totalTasksCompleted">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Avg Tasks/Day</td>
                                <td class="stat-value" id="avgTasksPerDay">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Task Completion Rate</td>
                                <td class="stat-value" id="taskCompletionRate">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Most Productive Bucket</td>
                                <td class="stat-value" id="bestBucket">-</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Distraction Analysis -->
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">üö´ Top Distractions</h4>
                        <div id="topDistractions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Weekly Comparison -->
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">üìÖ Week-over-Week</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td class="stat-label">This Week's Avg Grade</td>
                                <td class="stat-value" id="thisWeekGrade">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Last Week's Avg Grade</td>
                                <td class="stat-value" id="lastWeekGrade">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Trend</td>
                                <td class="stat-value" id="weekTrend">-</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Best Week</td>
                                <td class="stat-value" id="bestWeek">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Insights Summary -->
                <div id="analyticsInsights" style="background: var(--bg-secondary); border-left: 3px solid var(--industrial-orange); padding: 1.5rem; border-radius: 4px; margin-top: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">üí° Insights</h4>
                    <p id="insightsText" style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; margin: 0;">
                        Loading insights...
                    </p>
                </div>
            </div>
            
            <!-- Premium Upgrade CTA (shown for non-premium users) -->
            <div id="premiumUpgradeCTA" class="stats-table hidden" style="margin-top: 3rem; text-align: center; background: linear-gradient(135deg, rgba(245, 91, 7, 0.1) 0%, rgba(245, 91, 7, 0.05) 100%); border: 2px dashed rgba(245, 91, 7, 0.3); padding: 3rem 2rem;">
                <div style="font-size: 48px; margin-bottom: 1rem;">üìà</div>
                <h3 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Unlock Historical Analytics</h3>
                <p style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                    See your productivity patterns, peak performance times, and get AI-generated insights with Premium.
                </p>
                <a href="upgrade.html" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1rem;">‚≠ê Upgrade to Premium</a>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="app.html">üéØ Workspace</a>
        <span class="footer-separator">|</span>
        <a href="how-to.html">üìñ How-to</a>
        <span class="footer-separator">|</span>
        <a href="guide.html">üí¨ Support</a>
        <span class="footer-separator">|</span>
        <a href="app.html#feedback" style="color: var(--industrial-orange);">üéØ Beta Feedback</a>
    </footer>

    <!-- Mode Configuration System -->
    <script src="config.js"></script>
    
    <!-- Weekly Reports -->
    <script src="weekly-reports.js"></script>

    <script>
        // ============================================
        // LOCALSTORAGE AUTHENTICATION CHECK
        // ============================================
        
        // User is already authenticated (came from app.html)
        // No need to check auth here - if they can access app.html, they're logged in
        
        // Set up logout function
        window.handleFirebaseLogout = function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear(); // Clear all app data
                window.location.href = 'start.html';
            }
        };
        
        console.log('‚úÖ Dashboard loaded');
    </script>

    <script>
        // ============================================
        // DASHBOARD INITIALIZATION
        // ============================================
        // User is already authenticated if they reached this page
        
        // ============================================
        // STORAGE HELPERS (No user-specific keys needed)
        // ============================================
        function getUserKey(baseKey) {
            // Simply return base key - no user-specific keying needed
            return baseKey;
        }
        
        function getUserItem(baseKey) {
            return localStorage.getItem(baseKey);
        }
        
        function setUserItem(baseKey, value) {
            localStorage.setItem(baseKey, value);
        }
        
        // Display current mode
        function displayCurrentMode() {
            const modeEl = document.getElementById('currentMode');
            if (modeEl && window.getModeDisplayName) {
                modeEl.textContent = getModeDisplayName().toUpperCase();
            }
            
            // Check if admin from membership
            try {
                const membership = JSON.parse(localStorage.getItem('focushub_membership') || '{}');
                if (membership.is_admin) {
                    const adminLink = document.getElementById('adminLink');
                    if (adminLink) adminLink.classList.remove('hidden');
                }
            } catch (e) {
                console.log('Could not check admin status');
            }
            
            // Show upgrade button if user is on free plan
            try {
                const membership = JSON.parse(localStorage.getItem('focushub_membership') || '{}');
                if (!membership.version || membership.version === 'lite') {
                    const upgradeBtn = document.getElementById('upgradeBtn');
                    if (upgradeBtn) upgradeBtn.classList.remove('hidden');
                }
            } catch (e) {
                console.log('Could not check membership');
            }
        }
        
        // Return to admin panel
        function returnToAdmin() {
            const adminReturn = sessionStorage.getItem('admin_return');
            if (!adminReturn) return;
            
            const adminUser = JSON.parse(adminReturn);
            
            // Restore admin session
            localStorage.setItem('focushub_current_user', JSON.stringify(adminUser));
            localStorage.setItem('focushub_mode', adminUser.mode);
            
            // Clear impersonation
            sessionStorage.removeItem('admin_return');
            
            // Return to admin panel
            window.location.href = 'settings.html';
        }
        
        // Update current time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toUTCString();
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Display mode on load
        displayCurrentMode();

        // Load stats from history
        function loadStats() {
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            
            if (history.length === 0) {
                // Show empty state
                const emptyState = document.getElementById('overviewEmptyState');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
            
            // Hide empty state if there's data
            const emptyState = document.getElementById('overviewEmptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            // Calculate total sprints
            const totalSprints = history.reduce((sum, day) => sum + day.sprintCount, 0);
            document.getElementById('totalSprints').textContent = totalSprints;
            document.getElementById('totalSprintsContext').textContent = totalSprints;

            // Calculate total tasks
            const totalTasks = history.reduce((sum, day) => sum + day.tasksCompleted, 0);
            document.getElementById('totalTasks').textContent = totalTasks;

            // Calculate streak (consecutive days with B+ or higher)
            const gradeThreshold = ['A+', 'A', 'A-', 'B+', 'B'];
            let streak = 0;
            for (let i = history.length - 1; i >= 0; i--) {
                const grade = history[i].userGrade || history[i].autoGrade;
                if (gradeThreshold.includes(grade)) {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('dayStreak').textContent = streak;

            // Calculate average grade
            const gradeValues = {
                'A+': 4.3, 'A': 4.0, 'A-': 3.7,
                'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                'C+': 2.3, 'C': 2.0, 'C-': 1.7,
                'D+': 1.3, 'D': 1.0, 'D-': 0.7,
                'F': 0.0
            };
            const avgGradeValue = history.reduce((sum, day) => {
                return sum + (gradeValues[day.userGrade || day.autoGrade] || 0);
            }, 0) / history.length;
            
            document.getElementById('avgGrade').textContent = avgGradeValue.toFixed(1);
            document.getElementById('focusScore').textContent = ((avgGradeValue / 4.3) * 100).toFixed(0) + '%';

            // Days logged
            document.getElementById('daysLogged').textContent = history.length;

            // Average distractions
            const avgDistractions = (history.reduce((sum, day) => sum + day.distractionCount, 0) / history.length).toFixed(1);
            document.getElementById('avgDistractions').textContent = avgDistractions;

            // Sprint completion rate
            const sprintRate = history.reduce((sum, day) => {
                return sum + Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
            }, 0) / history.length;
            document.getElementById('sprintRate').textContent = sprintRate.toFixed(0) + '%';

            // Weekly chart (last 7 days)
            const last7 = history.slice(-7);
            const chartHTML = last7.map(day => {
                const percentage = Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
                // Muted gray default, brand orange for 100%+ completion
                const color = percentage >= 100 ? '#f45b07' : '#6b7280';
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                return `
                    <div class="bar-mini">
                        <div class="bar-fill" style="height: ${percentage}%; background: ${color}"></div>
                        <div class="bar-day">${dayName}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('weeklyChart').innerHTML = chartHTML;

            // Intention vs Reality
            const intentions = JSON.parse(getUserItem('focushub_intentions') || '[]');
            const intentionCount = intentions.length;
            const followedThrough = intentions.filter(i => i.completed).length;
            
            document.getElementById('intentionCount').textContent = intentionCount;
            document.getElementById('realityCount').textContent = followedThrough;
            
            if (intentionCount > 0) {
                const intentionPercent = 100;
                const realityPercent = (followedThrough / intentionCount) * 100;
                document.getElementById('intentionFill').style.width = intentionPercent + '%';
                document.getElementById('realityFill').style.width = realityPercent + '%';
            }
            
            // Subject breakdown (student mode only)
            loadSubjectBreakdown();
            
            // Load grade history
            loadGradeHistory();
        }
        
        // Load and display grade history
        function loadGradeHistory() {
            const gradeHistory = JSON.parse(localStorage.getItem('focushub_grade_history') || '[]');
            const container = document.getElementById('gradeHistoryContent');
            
            if (gradeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No grades yet. Complete a day to see your first grade!</p>';
                return;
            }
            
            // Show last 10 grades
            const recent = gradeHistory.slice(-10).reverse();
            
            let html = '<div style="display: grid; gap: 1rem;">';
            
            recent.forEach(grade => {
                const date = new Date(grade.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const aligned = grade.systemGrade === grade.userGrade;
                const alignmentIcon = aligned ? '‚úÖ' : '‚ö†Ô∏è';
                const alignmentText = aligned ? 'Aligned' : 'Misaligned';
                const alignmentColor = aligned ? '#10b981' : '#f59e0b';
                
                html += `
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 4px; border-left: 4px solid ${alignmentColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">${dateStr}</span>
                            <span style="color: ${alignmentColor}; font-weight: 600; font-size: 0.875rem;">${alignmentIcon} ${alignmentText}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">System Grade</div>
                                <div style="color: var(--industrial-orange); font-size: 1.5rem; font-weight: 700;">${grade.systemGrade}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">Your Grade</div>
                                <div style="color: var(--text-primary); font-size: 1.5rem; font-weight: 700;">${grade.userGrade}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">Sprints</div>
                                <div style="color: var(--text-primary); font-size: 1.5rem; font-weight: 700;">${grade.sprints}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add alignment stats
            const totalGrades = gradeHistory.length;
            const alignedCount = gradeHistory.filter(g => g.systemGrade === g.userGrade).length;
            const alignmentRate = ((alignedCount / totalGrades) * 100).toFixed(0);
            
            html += `
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-elevated); border-radius: 4px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Self-Assessment Accuracy</div>
                    <div style="color: var(--industrial-orange); font-size: 2rem; font-weight: 700;">${alignmentRate}%</div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">${alignedCount} of ${totalGrades} aligned</div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Calculate and display subject breakdown
        function loadSubjectBreakdown() {
            const config = window.loadModeConfig ? loadModeConfig() : null;
            const subjectSection = document.getElementById('subjectBreakdownSection');
            
            // Only show for student mode
            if (!config || !config.features || !config.features.subjects) {
                if (subjectSection) {
                    subjectSection.classList.add('hidden');
                }
                return;
            }
            
            // Show section
            if (subjectSection) {
                subjectSection.classList.remove('hidden');
            }
            
            // Get completed tasks from history
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            const subjectSprints = {};
            
            // Calculate sprints per subject from all history
            history.forEach(day => {
                if (day.wins && Array.isArray(day.wins)) {
                    day.wins.forEach(task => {
                        if (task.subject) {
                            subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                        }
                    });
                }
            });
            
            // Also check current tasks
            const currentTasks = JSON.parse(getUserItem('focushub_tasks') || '{"wins":[]}');
            if (currentTasks.wins && Array.isArray(currentTasks.wins)) {
                currentTasks.wins.forEach(task => {
                    if (task.subject) {
                        subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                    }
                });
            }
            
            // Render subject breakdown
            const breakdownEl = document.getElementById('subjectBreakdown');
            if (!breakdownEl) return;
            
            if (Object.keys(subjectSprints).length === 0) {
                breakdownEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No subjects tracked yet. Complete tasks with subjects to see breakdown.</p>';
                return;
            }
            
            const totalSprints = Object.values(subjectSprints).reduce((a, b) => a + b, 0);
            
            const html = Object.entries(subjectSprints)
                .sort((a, b) => b[1] - a[1]) // Sort by sprints descending
                .map(([subject, sprints]) => {
                    const percentage = ((sprints / totalSprints) * 100).toFixed(0);
                    return `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; color: var(--text-primary);">${subject}</span>
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">${sprints} sprints (${percentage}%)</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: var(--primary-color);"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            breakdownEl.innerHTML = html;
        }

        // Theme detection and logo swap
        function initTheme() {
            const theme = localStorage.getItem('focushub_theme') || 'dark';
            const dashboardLogo = document.getElementById('dashboardLogo');
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                dashboardLogo.src = 'FocusHub_vertinv.svg'; // Dark = white text
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                dashboardLogo.src = 'FocusHub_vertnorm.svg'; // Light = black text
            }
        }

        // Check session state and update button
        function checkSessionState() {
            const sessionState = getUserItem('focushub_session_state');
            const dailyStats = getUserItem('focushub_daily_stats');
            const button = document.querySelector('.primary-action');
            
            // If session is active (not ended and has data)
            if (sessionState !== 'ended' && dailyStats) {
                const stats = JSON.parse(dailyStats);
                const today = new Date().toDateString();
                
                // Check if stats are from today
                if (stats.date === today) {
                    button.innerHTML = `
                        <span class="action-icon">[ &gt; ]</span>
                        <span class="action-text">RETURN TO WORKSPACE</span>
                    `;
                }
            }
        }

        // Update dashboard timer display
        function updateDashboardTimer() {
            const savedTimer = getUserItem('focushub_timer');
            if (!savedTimer) {
                document.getElementById('dashboardTimer').classList.add('hidden');
                return;
            }
            
            const timerData = JSON.parse(savedTimer);
            
            if (timerData.isRunning && timerData.timeLeft > 0) {
                // Calculate current time left
                const elapsed = Math.floor((Date.now() - timerData.lastUpdated) / 1000);
                const timeLeft = Math.max(0, timerData.timeLeft - elapsed);
                
                if (timeLeft > 0) {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    document.getElementById('dashboardTimerText').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    document.getElementById('dashboardTimer').classList.remove('hidden');
                    
                    // Update every second
                    setTimeout(updateDashboardTimer, 1000);
                } else {
                    document.getElementById('dashboardTimer').classList.add('hidden');
                }
            } else {
                document.getElementById('dashboardTimer').classList.add('hidden');
            }
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (window.handleFirebaseLogout) {
                window.handleFirebaseLogout();
            }
        });

        initTheme();
        checkSessionState();
        updateDashboardTimer();
        loadStats();
        loadUserTier();
        initPremiumAnalytics();
    </script>
    
    <script>
        // ============================================
        // USER TIER DISPLAY & MANAGEMENT
        // ============================================
        
        async function loadUserTier() {
            try {
                // Get user tier from Supabase
                const tier = await getUserTier();
                const trialStatus = await checkTrialStatus();
                
                // Update tier badge
                const tierBadge = document.getElementById('tierBadge');
                const tierEmoji = document.getElementById('tierEmoji');
                const tierName = document.getElementById('tierName');
                
                if (tierBadge && tierEmoji && tierName) {
                    tierEmoji.textContent = getTierEmoji(tier);
                    tierName.textContent = getTierDisplayName(tier).toUpperCase();
                    tierBadge.style.borderColor = getTierColor(tier);
                    tierName.style.color = getTierColor(tier);
                }
                
                // Show upgrade button for non-premium users
                const upgradeBtn = document.getElementById('upgradeBtn');
                if (upgradeBtn) {
                    const isPremium = await isPremiumUser();
                    if (!isPremium) {
                        upgradeBtn.classList.remove('hidden');
                    }
                }
                
                // Show trial banner if in trial
                if (trialStatus.inTrial) {
                    showTrialBanner(trialStatus.daysRemaining, tier);
                }
                
                // Store tier in session for quick access
                sessionStorage.setItem('focushub_user_tier', tier);
                
            } catch (error) {
                console.error('Error loading user tier:', error);
                // Fallback to lite tier display
                const tierName = document.getElementById('tierName');
                if (tierName) tierName.textContent = 'LITE';
            }
        }
        
        function showTrialBanner(daysRemaining, tier) {
            // Create trial banner if it doesn't exist
            let banner = document.getElementById('trialBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'trialBanner';
                banner.style.cssText = `
                    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
                    border: 1px solid rgba(168, 85, 247, 0.3);
                    padding: 1rem;
                    text-align: center;
                    margin-bottom: 1.5rem;
                    border-radius: 8px;
                `;
                
                const container = document.querySelector('.mission-control .container');
                const firstChild = container.firstElementChild;
                container.insertBefore(banner, firstChild);
            }
            
            let message = '';
            if (tier === 'lite') {
                message = `‚è±Ô∏è <strong>${daysRemaining} days left</strong> in your free trial. <a href="upgrade.html" style="color: var(--industrial-orange); font-weight: 600;">Subscribe to Lite ($3.99/mo)</a> to continue after trial.`;
            } else {
                const tierPrice = tier === 'pro' ? '$4.99' : '$9.99';
                const fullPrice = tier === 'pro' ? '$9.99/mo' : '$19.99/mo';
                message = `‚è±Ô∏è <strong>${daysRemaining} days left</strong> at trial rate (${tierPrice}). <a href="upgrade.html" style="color: var(--industrial-orange); font-weight: 600;">Continue at ${fullPrice}</a> or downgrade.`;
            }
            
            banner.innerHTML = `<p style="margin: 0; font-size: 0.875rem; color: var(--text-primary);">${message}</p>`;
        }
    </script>
    
    <script>
        // ============================================
        // PREMIUM HISTORICAL ANALYTICS
        // ============================================
        
        let currentAnalyticsPeriod = 30; // Default to 30 days
        
        async function initPremiumAnalytics() {
            // Check if user has premium access
            const isPremium = await checkPremiumAccess();
            
            const analyticsSection = document.getElementById('premiumAnalyticsSection');
            const upgradeCTA = document.getElementById('premiumUpgradeCTA');
            
            if (isPremium) {
                // Show analytics, hide CTA
                if (analyticsSection) analyticsSection.classList.remove('hidden');
                if (upgradeCTA) upgradeCTA.classList.add('hidden');
                
                // Load analytics data
                loadAnalyticsPeriod(30);
            } else {
                // Hide analytics, show CTA
                if (analyticsSection) analyticsSection.classList.add('hidden');
                if (upgradeCTA) upgradeCTA.classList.remove('hidden');
            }
        }
        
        async function checkPremiumAccess() {
            // Check if user has premium tier from Supabase
            try {
                const isPremium = await isPremiumUser();
                return isPremium;
            } catch (error) {
                console.error('Error checking premium access:', error);
                return false;
            }
        }
        
        function loadAnalyticsPeriod(days) {
            currentAnalyticsPeriod = days;
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = days === 0 ? 'periodAll' : `period${days}`;
            document.getElementById(activeBtn)?.classList.add('active');
            
            // Calculate date range
            const endDate = new Date();
            const startDate = days === 0 ? new Date('2020-01-01') : new Date(endDate - days * 24 * 60 * 60 * 1000);
            
            // Load data from history
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            const filteredHistory = history.filter(session => {
                const sessionDate = new Date(session.date);
                return sessionDate >= startDate && sessionDate <= endDate;
            });
            
            // Calculate analytics
            calculateAndDisplayAnalytics(filteredHistory, days);
        }
        
        function calculateAndDisplayAnalytics(history, periodDays) {
            if (history.length === 0) {
                displayEmptyState();
                return;
            }
            
            // === 1. BEST DAY OF WEEK ===
            const dayCount = {};
            const dayGrades = {};
            history.forEach(session => {
                const dayOfWeek = new Date(session.date).toLocaleDateString('en-US', { weekday: 'long' });
                dayCount[dayOfWeek] = (dayCount[dayOfWeek] || 0) + 1;
                dayGrades[dayOfWeek] = dayGrades[dayOfWeek] || [];
                dayGrades[dayOfWeek].push(gradeToNumber(session.grade));
            });
            
            let bestDay = '-';
            let bestDayScore = 0;
            Object.keys(dayGrades).forEach(day => {
                const avgGrade = dayGrades[day].reduce((a, b) => a + b, 0) / dayGrades[day].length;
                if (avgGrade > bestDayScore) {
                    bestDayScore = avgGrade;
                    bestDay = day;
                }
            });
            document.getElementById('bestDayOfWeek').textContent = bestDay;
            
            // === 2. MOST PRODUCTIVE HOUR ===
            // Would need sprint-level timestamps - placeholder for now
            document.getElementById('bestHour').textContent = 'Coming Soon';
            
            // === 3. AVG SPRINTS PER DAY ===
            const totalSprints = history.reduce((sum, s) => sum + (s.sprintsCompleted || 0), 0);
            const avgSprints = (totalSprints / history.length).toFixed(1);
            document.getElementById('avgSprintsPerDay').textContent = avgSprints;
            
            // === 4. SPRINT COMPLETION RATE ===
            const sprintsPlanned = history.reduce((sum, s) => sum + (s.sprintsPlanned || 0), 0);
            const sprintsCompleted = history.reduce((sum, s) => sum + (s.sprintsCompleted || 0), 0);
            const sprintCompletionRate = sprintsPlanned > 0 
                ? ((sprintsCompleted / sprintsPlanned) * 100).toFixed(0) + '%'
                : '-';
            document.getElementById('sprintCompletionRate').textContent = sprintCompletionRate;
            
            // === 5. TASK PATTERNS ===
            const totalTasksCompleted = history.reduce((sum, s) => sum + (s.tasksCompleted || 0), 0);
            const avgTasksPerDay = (totalTasksCompleted / history.length).toFixed(1);
            document.getElementById('totalTasksCompleted').textContent = totalTasksCompleted;
            document.getElementById('avgTasksPerDay').textContent = avgTasksPerDay;
            
            // Task completion rate (completed vs total tasks)
            const totalTasksAdded = history.reduce((sum, s) => sum + ((s.tasksCompleted || 0) + (s.tasksIncomplete || 0)), 0);
            const taskCompletionRate = totalTasksAdded > 0
                ? ((totalTasksCompleted / totalTasksAdded) * 100).toFixed(0) + '%'
                : '-';
            document.getElementById('taskCompletionRate').textContent = taskCompletionRate;
            
            // Most productive bucket (Strategic, Deep Work, Urgent)
            const bucketCounts = { Strategic: 0, 'Deep Work': 0, Urgent: 0 };
            history.forEach(session => {
                if (session.tasksByBucket) {
                    Object.keys(session.tasksByBucket).forEach(bucket => {
                        bucketCounts[bucket] = (bucketCounts[bucket] || 0) + session.tasksByBucket[bucket];
                    });
                }
            });
            const bestBucket = Object.entries(bucketCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
            document.getElementById('bestBucket').textContent = bestBucket;
            
            // === 6. TOP DISTRACTIONS ===
            const distractionCount = {};
            history.forEach(session => {
                if (session.distractions && Array.isArray(session.distractions)) {
                    session.distractions.forEach(d => {
                        const name = d.what || d;
                        distractionCount[name] = (distractionCount[name] || 0) + 1;
                    });
                }
            });
            
            const topDistractions = Object.entries(distractionCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const distractionsContainer = document.getElementById('topDistractions');
            if (topDistractions.length === 0) {
                distractionsContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No distractions logged</p>';
            } else {
                distractionsContainer.innerHTML = topDistractions.map(([name, count]) => `
                    <div class="distraction-item">
                        <span class="distraction-name">${name}</span>
                        <span class="distraction-count">${count}x</span>
                    </div>
                `).join('');
            }
            
            // === 7. WEEK-OVER-WEEK COMPARISON ===
            const now = new Date();
            const thisWeekStart = new Date(now);
            thisWeekStart.setDate(now.getDate() - now.getDay()); // Start of this week (Sunday)
            
            const lastWeekStart = new Date(thisWeekStart);
            lastWeekStart.setDate(thisWeekStart.getDate() - 7);
            
            const thisWeekSessions = history.filter(s => new Date(s.date) >= thisWeekStart);
            const lastWeekSessions = history.filter(s => {
                const d = new Date(s.date);
                return d >= lastWeekStart && d < thisWeekStart;
            });
            
            const thisWeekAvg = thisWeekSessions.length > 0
                ? (thisWeekSessions.reduce((sum, s) => sum + gradeToNumber(s.grade), 0) / thisWeekSessions.length).toFixed(1)
                : 0;
            const lastWeekAvg = lastWeekSessions.length > 0
                ? (lastWeekSessions.reduce((sum, s) => sum + gradeToNumber(s.grade), 0) / lastWeekSessions.length).toFixed(1)
                : 0;
            
            document.getElementById('thisWeekGrade').textContent = thisWeekAvg > 0 ? numberToGrade(thisWeekAvg) : '-';
            document.getElementById('lastWeekGrade').textContent = lastWeekAvg > 0 ? numberToGrade(lastWeekAvg) : '-';
            
            // Calculate trend
            let trendText = '-';
            let trendColor = 'var(--text-secondary)';
            if (thisWeekAvg > 0 && lastWeekAvg > 0) {
                const diff = thisWeekAvg - lastWeekAvg;
                if (diff > 3) {
                    trendText = 'üìà Improving';
                    trendColor = 'var(--success)';
                } else if (diff < -3) {
                    trendText = 'üìâ Declining';
                    trendColor = '#ef4444';
                } else {
                    trendText = '‚û°Ô∏è Stable';
                    trendColor = 'var(--industrial-orange)';
                }
            }
            const trendEl = document.getElementById('weekTrend');
            trendEl.textContent = trendText;
            trendEl.style.color = trendColor;
            
            // Best week ever
            const weeklyAverages = [];
            let weekStart = new Date(history[0].date);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            
            while (weekStart < now) {
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                
                const weekSessions = history.filter(s => {
                    const d = new Date(s.date);
                    return d >= weekStart && d < weekEnd;
                });
                
                if (weekSessions.length > 0) {
                    const weekAvg = weekSessions.reduce((sum, s) => sum + gradeToNumber(s.grade), 0) / weekSessions.length;
                    weeklyAverages.push({ start: new Date(weekStart), avg: weekAvg });
                }
                
                weekStart.setDate(weekStart.getDate() + 7);
            }
            
            if (weeklyAverages.length > 0) {
                const bestWeekData = weeklyAverages.sort((a, b) => b.avg - a.avg)[0];
                const bestWeekDate = bestWeekData.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('bestWeek').textContent = bestWeekDate + ' (' + numberToGrade(bestWeekData.avg) + ')';
            } else {
                document.getElementById('bestWeek').textContent = '-';
            }
            
            // === 8. GENERATE AI INSIGHTS ===
            generateInsights(history, periodDays, bestDay, avgSprints, topDistractions, sprintCompletionRate, trendText);
            
            // === 9. DRAW TREND CHART ===
            drawTrendChart(history);
        }
        
        function generateInsights(history, days, bestDay, avgSprints, topDistractions, sprintCompletionRate, trendText) {
            const insights = [];
            
            // Best day insight
            if (bestDay !== '-') {
                insights.push(`Your most productive day is ${bestDay}.`);
            }
            
            // Sprint consistency
            if (parseFloat(avgSprints) >= 5) {
                insights.push(`You're averaging ${avgSprints} sprints per day - solid consistency.`);
            } else if (parseFloat(avgSprints) < 3) {
                insights.push(`You're averaging ${avgSprints} sprints per day. Consider setting a minimum daily target.`);
            }
            
            // Sprint completion rate
            const completionPercent = parseInt(sprintCompletionRate);
            if (completionPercent >= 80) {
                insights.push(`${sprintCompletionRate} sprint completion rate - excellent follow-through.`);
            } else if (completionPercent < 60 && completionPercent > 0) {
                insights.push(`${sprintCompletionRate} sprint completion. Try planning fewer sprints but finishing them all.`);
            }
            
            // Distraction pattern
            if (topDistractions.length > 0) {
                const topDistraction = topDistractions[0][0];
                const topCount = topDistractions[0][1];
                if (topCount > 10) {
                    insights.push(`"${topDistraction}" is your #1 distraction (${topCount}x). Consider blocking it during sprints.`);
                }
            }
            
            // Week-over-week trend
            if (trendText.includes('Improving')) {
                insights.push('Week-over-week performance is improving. Keep this momentum.');
            } else if (trendText.includes('Declining')) {
                insights.push('Recent week dipped. Consider adjusting sprint durations or reducing planned workload.');
            }
            
            // Grade trend
            const recentGrades = history.slice(-7).map(s => gradeToNumber(s.grade));
            if (recentGrades.length >= 3) {
                const avgRecent = recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length;
                if (avgRecent >= 85) {
                    insights.push('Recent performance is strong.');
                } else if (avgRecent < 70) {
                    insights.push('Recent performance below your baseline. Take a break or adjust expectations.');
                }
            }
            
            const insightsText = insights.length > 0 
                ? insights.join(' ') 
                : 'Keep logging sessions to unlock personalized insights.';
            
            document.getElementById('insightsText').textContent = insightsText;
        }
        
        function numberToGrade(num) {
            if (num >= 97) return 'A+';
            if (num >= 93) return 'A';
            if (num >= 90) return 'A-';
            if (num >= 87) return 'B+';
            if (num >= 83) return 'B';
            if (num >= 80) return 'B-';
            if (num >= 77) return 'C+';
            if (num >= 73) return 'C';
            if (num >= 70) return 'C-';
            if (num >= 67) return 'D+';
            if (num >= 63) return 'D';
            if (num >= 60) return 'D-';
            return 'F';
        }
        
        function drawTrendChart(history) {
            // Enhanced line chart showing grade trend over time with color zones
            const canvas = document.getElementById('trendCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            if (history.length < 2) {
                ctx.fillStyle = '#666';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Need more data to show trend', width / 2, height / 2);
                return;
            }
            
            // Get data based on current period
            let dataToShow = history;
            if (currentAnalyticsPeriod === 30) {
                dataToShow = history.slice(-30);
            } else if (currentAnalyticsPeriod === 60) {
                dataToShow = history.slice(-60);
            } else if (currentAnalyticsPeriod === 90) {
                dataToShow = history.slice(-90);
            }
            
            // Limit to max 30 points for readability
            if (dataToShow.length > 30) {
                const step = Math.ceil(dataToShow.length / 30);
                dataToShow = dataToShow.filter((_, i) => i % step === 0);
            }
            
            const grades = dataToShow.map(s => gradeToNumber(s.grade));
            
            // Draw background grade zones
            const yScale = (height - 50) / 100;
            
            // A zone (90-100) - Green
            ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
            ctx.fillRect(40, 10, width - 50, (100 - 90) * yScale);
            
            // B zone (80-90) - Yellow
            ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
            ctx.fillRect(40, 10 + (100 - 90) * yScale, width - 50, 10 * yScale);
            
            // C zone (70-80) - Orange
            ctx.fillStyle = 'rgba(245, 91, 7, 0.1)';
            ctx.fillRect(40, 10 + (100 - 80) * yScale, width - 50, 10 * yScale);
            
            // D/F zone (below 70) - Red
            ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
            ctx.fillRect(40, 10 + (100 - 70) * yScale, width - 50, 70 * yScale);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, 10);
            ctx.lineTo(40, height - 30);
            ctx.lineTo(width - 10, height - 30);
            ctx.stroke();
            
            // Draw grade markers on Y axis
            ctx.fillStyle = '#666';
            ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'right';
            [100, 90, 80, 70, 60].forEach(grade => {
                const y = height - 30 - (grade * yScale);
                ctx.fillText(numberToGrade(grade), 35, y + 3);
            });
            
            // Draw grade line with gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#22c55e'); // Green at top
            gradient.addColorStop(0.3, '#f59e0b'); // Yellow
            gradient.addColorStop(0.6, '#f55b07'); // Orange
            gradient.addColorStop(1, '#ef4444'); // Red at bottom
            
            ctx.strokeStyle = '#f55b07';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const xStep = (width - 60) / (grades.length - 1);
            
            grades.forEach((grade, i) => {
                const x = 40 + (i * xStep);
                const y = height - 30 - (grade * yScale);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points with size based on performance
            grades.forEach((grade, i) => {
                const x = 40 + (i * xStep);
                const y = height - 30 - (grade * yScale);
                
                // Color code points
                let pointColor = '#ef4444'; // Red default
                if (grade >= 90) pointColor = '#22c55e'; // Green
                else if (grade >= 80) pointColor = '#f59e0b'; // Yellow
                else if (grade >= 70) pointColor = '#f55b07'; // Orange
                
                ctx.fillStyle = pointColor;
                ctx.beginPath();
                const radius = grade >= 85 ? 5 : 3; // Bigger dots for good days
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
                
                // White border on points
                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
            
            // Draw trend line (moving average)
            if (grades.length >= 5) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                
                for (let i = 2; i < grades.length - 2; i++) {
                    const avgGrade = (grades[i-2] + grades[i-1] + grades[i] + grades[i+1] + grades[i+2]) / 5;
                    const x = 40 + (i * xStep);
                    const y = height - 30 - (avgGrade * yScale);
                    
                    if (i === 2) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            const periodLabel = currentAnalyticsPeriod === 0 ? 'All Time' : `Last ${currentAnalyticsPeriod} Days`;
            ctx.fillText(periodLabel, width / 2, height - 5);
        }
        
        function gradeToNumber(grade) {
            const gradeMap = {
                'A+': 100, 'A': 95, 'A-': 90,
                'B+': 87, 'B': 83, 'B-': 80,
                'C+': 77, 'C': 73, 'C-': 70,
                'D+': 67, 'D': 63, 'D-': 60,
                'F': 50
            };
            return gradeMap[grade] || 50;
        }
        
        function displayEmptyState() {
            // Peak Performance
            document.getElementById('bestDayOfWeek').textContent = '-';
            document.getElementById('bestHour').textContent = '-';
            document.getElementById('avgSprintsPerDay').textContent = '-';
            document.getElementById('sprintCompletionRate').textContent = '-';
            
            // Task Patterns
            document.getElementById('totalTasksCompleted').textContent = '-';
            document.getElementById('avgTasksPerDay').textContent = '-';
            document.getElementById('taskCompletionRate').textContent = '-';
            document.getElementById('bestBucket').textContent = '-';
            
            // Distractions
            document.getElementById('topDistractions').innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No data yet</p>';
            
            // Week-over-Week
            document.getElementById('thisWeekGrade').textContent = '-';
            document.getElementById('lastWeekGrade').textContent = '-';
            document.getElementById('weekTrend').textContent = '-';
            document.getElementById('bestWeek').textContent = '-';
            
            // Insights
            document.getElementById('insightsText').textContent = 'Complete more sessions to unlock insights.';
        }
        
        // ============================================
        // DATA EXPORT
        // ============================================
        
        function exportAnalytics() {
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            
            if (history.length === 0) {
                alert('No data to export yet. Complete some sessions first!');
                return;
            }
            
            // Create CSV content
            let csv = 'Date,Day of Week,Grade,Grade Number,Sprints Planned,Sprints Completed,Tasks Completed,Distractions,Notes\n';
            
            history.forEach(session => {
                const date = session.date || '';
                const dayOfWeek = date ? new Date(date).toLocaleDateString('en-US', { weekday: 'long' }) : '';
                const grade = session.grade || '';
                const gradeNum = gradeToNumber(grade);
                const sprintsPlanned = session.sprintsPlanned || 0;
                const sprintsCompleted = session.sprintsCompleted || 0;
                const tasksCompleted = session.tasksCompleted || 0;
                const distractions = session.distractions ? session.distractions.length : 0;
                const notes = (session.notes || '').replace(/"/g, '""'); // Escape quotes
                
                csv += `"${date}","${dayOfWeek}","${grade}",${gradeNum},${sprintsPlanned},${sprintsCompleted},${tasksCompleted},${distractions},"${notes}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `focushub_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ Analytics exported:', filename);
        }
    </script>

    <!-- Floating AI Support Button -->
    <button id="aiSupportToggle" style="position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; background: var(--industrial-orange); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" aria-label="Open support chat">
        üí¨
    </button>

    <!-- AI Support Panel (hidden by default) -->
    <div id="aiSupportPanel" style="display: none; position: fixed; bottom: 5rem; right: 2rem; width: 360px; max-height: 500px; background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); z-index: 1000; overflow: hidden;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-light);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">FocusHub Support</h3>
                <button id="closeAiPanel" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; padding: 0;">√ó</button>
            </div>
        </div>
        
        <div id="aiChatMessages" style="height: 320px; overflow-y: auto; padding: 1rem; background: var(--bg-primary);">
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 1rem;">
                <p style="font-size: 14px; color: var(--text-primary); margin: 0;">Ask questions about how FocusHub works, its features, or troubleshooting.</p>
            </div>
        </div>

        <div style="padding: 1rem; border-top: 1px solid var(--border-light);">
            <div style="display: flex; gap: 0.5rem;">
                <input 
                    type="text" 
                    id="aiChatInput" 
                    placeholder="Type your question..."
                    style="flex: 1; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-medium); color: var(--text-primary); font-size: 14px; border-radius: 4px;"
                >
                <button id="aiSendMessage" style="background: var(--industrial-orange); color: white; padding: 0.75rem 1rem; border: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 4px;">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        // AI Support Panel Toggle
        const aiToggle = document.getElementById('aiSupportToggle');
        const aiPanel = document.getElementById('aiSupportPanel');
        const aiClose = document.getElementById('closeAiPanel');

        if (aiToggle && aiPanel && aiClose) {
            aiToggle.addEventListener('click', () => {
                const isVisible = aiPanel.style.display !== 'none';
                aiPanel.style.display = isVisible ? 'none' : 'block';
            });

            aiClose.addEventListener('click', () => {
                aiPanel.style.display = 'none';
            });

            // Chat functionality
            const sendBtn = document.getElementById('aiSendMessage');
            const chatInput = document.getElementById('aiChatInput');
            const chatMessages = document.getElementById('aiChatMessages');

            if (sendBtn && chatInput && chatMessages) {
                sendBtn.addEventListener('click', sendAiMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendAiMessage();
                });

                function sendAiMessage() {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    // Add user message
                    const userMsg = document.createElement('div');
                    userMsg.style.cssText = 'background: var(--industrial-orange); color: white; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; margin-left: 2rem; font-size: 14px;';
                    userMsg.textContent = message;
                    chatMessages.appendChild(userMsg);

                    chatInput.value = '';

                    // Intelligent response based on keywords
                    const msgLower = message.toLowerCase();
                    let response = 'Check the How-To guide or FAQ for detailed guidance.';
                    
                    // Privacy-related responses
                    if (msgLower.includes('privacy') || msgLower.includes('data') || msgLower.includes('personal information')) {
                        response = 'üîí Your privacy is our priority! Task text is automatically deleted every Friday. View our Privacy Policy for details, or export/delete your data anytime from the footer.';
                    } else if (msgLower.includes('delete') && (msgLower.includes('account') || msgLower.includes('data'))) {
                        response = 'üóëÔ∏è To delete your account and all data: scroll to the footer and click "Delete My Account". This action is permanent and immediate.';
                    } else if (msgLower.includes('export') || msgLower.includes('download')) {
                        response = 'üì• To export all your data: scroll to the footer and click "Export My Data". You\'ll get a JSON file with everything.';
                    } else if (msgLower.includes('gdpr') || msgLower.includes('ccpa') || msgLower.includes('compliance')) {
                        response = '‚úÖ FocusHub is GDPR and CCPA compliant. We automatically delete task text weekly, never sell data, and give you complete control. See Privacy Policy for details.';
                    } else if (msgLower.includes('weekly') || msgLower.includes('friday') || msgLower.includes('deletion')) {
                        response = 'üìÖ Every Friday at 11:59 PM, we automatically delete all task text and personal information. We keep only anonymized statistics for 90 days to show trends.';
                    } else if (msgLower.includes('backup') || msgLower.includes('save')) {
                        response = 'üíæ Your data is automatically backed up! We keep rolling 7-day backups (encrypted), plus cloud sync if enabled. You can also export your data anytime.';
                    } else if (msgLower.includes('sync') || msgLower.includes('cloud')) {
                        response = '‚òÅÔ∏è Cloud sync is optional and encrypted. Your data is stored locally first, then optionally synced to secure Supabase servers. You can use FocusHub completely offline.';
                    } else if (msgLower.includes('secure') || msgLower.includes('encryption') || msgLower.includes('safe')) {
                        response = 'üîê Your data is encrypted in transit (TLS 1.3) and at rest (AES-256). We use Supabase (SOC 2 certified) for cloud storage. Local data stays on your device.';
                    }

                    // Simulate agent response
                    setTimeout(() => {
                        const agentMsg = document.createElement('div');
                        agentMsg.style.cssText = 'background: var(--bg-secondary); color: var(--text-primary); padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; margin-right: 2rem; font-size: 14px; line-height: 1.5;';
                        agentMsg.innerHTML = response;
                        chatMessages.appendChild(agentMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1000);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        }
    </script>

    <!-- Privacy & Data Management Footer -->
    <footer style="
        margin-top: 4rem;
        padding: 2rem;
        border-top: 1px solid var(--border-light);
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
    ">
        <div style="margin-bottom: 1rem;">
            <a href="/privacy.html" style="color: var(--primary-color); margin: 0 1rem;">Privacy Policy</a>
            <span style="color: var(--border-light);">|</span>
            <a href="/faq.html" style="color: var(--primary-color); margin: 0 1rem;">FAQ</a>
            <span style="color: var(--border-light);">|</span>
            <a href="/how-to.html" style="color: var(--primary-color); margin: 0 1rem;">How-To Guide</a>
        </div>
        <p style="margin: 0.5rem 0;">
            üîí Your tasks are automatically deleted every Friday<br>
            Data stored locally & optionally synced (encrypted)
        </p>
        <p style="margin: 0.5rem 0; font-size: 0.75rem;">
            &copy; 2026 FocusHub. Built for privacy.
        </p>
    </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mission Control - FocusHub</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Technical Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <img id="dashboardLogo" src="FocusHub_vertnorm.svg" alt="FocusHub" class="status-logo" style="height: 80px; width: auto;">
        </div>
        <div class="status-middle">
            <div id="dashboardTimer" class="dashboard-timer hidden">
                <span class="timer-icon">‚è±</span>
                <span id="dashboardTimerText">00:00</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span class="status-text">SYSTEM STATUS: ONLINE</span>
            </div>
            <div class="status-time" id="currentTime"></div>
            <a href="settings.html" id="adminLink" class="btn-home hidden" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--primary-color); font-weight: 600; font-size: 0.875rem; text-decoration: none;">Admin</a>
            <button id="logoutBtn" class="btn-home" style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem;">Logout</button>
        </div>
    </div>

    <!-- Admin Impersonation Banner -->
    <div id="impersonationBanner" class="impersonation-banner hidden">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <span>üëÅÔ∏è <strong>Viewing as:</strong> <span id="impersonatedEmail"></span></span>
            <button onclick="returnToAdmin()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Return to Admin</button>
        </div>
    </div>

    <!-- Mission Control Dashboard -->
    <div class="mission-control">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h1 class="mission-title" data-label="missionControl">MISSION CONTROL</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="mode-indicator" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 0.875rem; color: var(--text-secondary); padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px;">
                    MODE: <span id="currentMode" style="color: var(--text-primary); font-weight: 600;">LOADING...</span>
                </div>
                    <button onclick="window.WeeklyReports?.showReport()" class="btn btn-secondary" style="font-size: 0.875rem;">üìä Report</button>
                    <a href="upgrade.html" id="upgradeBtn" class="btn btn-primary hidden" style="font-size: 0.875rem;">‚ú® Upgrade</a>
                </div>
            </div>
            
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 2rem;">Overview of recent focus performance.</p>
            
            <!-- Bento Grid -->
            <div class="bento-grid">
                <!-- Empty State (shown when no sessions) -->
                <div id="overviewEmptyState" class="bento-card" style="grid-column: 1 / -1; display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üìä</div>
                    <h3 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5rem;">No sessions recorded.</h3>
                    <p style="color: var(--text-secondary); margin: 0;">Sessions appear here once completed.</p>
                </div>
                
                <!-- Total Sprints -->
                <div class="bento-card activity-flow">
                    <div class="card-micro-label">LIVE_TICKER_01</div>
                    <h3 class="card-title">Activity Flow</h3>
                    <div class="activity-chart">
                        <div class="metric-large" id="totalSprints">0</div>
                        <div class="metric-label">Total Sprints</div>
                    </div>
                    <div class="activity-context">
                        Total: <span id="totalSprintsContext">0</span> <span style="color: var(--text-secondary); font-size: 0.875rem;">(Last 7 days)</span>
                    </div>
                </div>

                <!-- Day Streak -->
                <div class="bento-card consistency-log">
                    <div class="card-micro-label">STREAK_TRACKER</div>
                    <h3 class="card-title">Consistency Log</h3>
                    <div class="consistency-chart">
                        <div class="metric-large" id="dayStreak">0</div>
                        <div class="metric-label">Day Streak (B+ or Higher)</div>
                    </div>
                    <div class="bar-chart-mini" id="weeklyChart"></div>
                </div>

                <!-- Focus Score -->
                <div class="bento-card daily-score">
                    <div class="card-micro-label">PERF_INDEX</div>
                    <h3 class="card-title">Performance Index</h3>
                    <div class="score-gauge">
                        <div class="gauge-value" id="focusScore">0%</div>
                        <div class="gauge-label">Avg Grade: <span id="avgGrade">N/A</span></div>
                    </div>
                    <div class="score-context">
                        Tasks Completed: <span class="streak-value" id="totalTasks">0</span>
                    </div>
                </div>

                <!-- NEW: Intention vs. Reality -->
                <div class="bento-card intention-reality">
                    <div class="card-micro-label">BEHAVIOR_DELTA</div>
                    <h3 class="card-title">Intention vs. Reality</h3>
                    <div class="intention-visual">
                        <div class="intention-bar">
                            <div class="intention-fill" id="intentionFill" style="width: 0%"></div>
                            <div class="intention-label">What You Said</div>
                        </div>
                        <div class="reality-bar">
                            <div class="reality-fill" id="realityFill" style="width: 0%"></div>
                            <div class="reality-label">What You Did</div>
                        </div>
                    </div>
                    <div class="intention-stats">
                        <div class="stat-item">
                            <span class="stat-num" id="intentionCount">0</span>
                            <span class="stat-desc">Declared Intentions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num" id="realityCount">0</span>
                            <span class="stat-desc">Followed Through</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Action -->
            <button class="primary-action" onclick="window.location.href='app.html'">
                <span class="action-icon">[ &gt; ]</span>
                <span class="action-text">RETURN TO WORKSPACE</span>
            </button>

            <!-- Quick Stats Table -->
            <div class="stats-table">
                <h3 class="stats-title">SYSTEM METRICS</h3>
                <table>
                    <tr>
                        <td class="stat-label">Days Logged</td>
                        <td class="stat-value" id="daysLogged">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Average Distractions/Day</td>
                        <td class="stat-value" id="avgDistractions">0</td>
                    </tr>
                    <tr>
                        <td class="stat-label">Sprint Completion Rate</td>
                        <td class="stat-value" id="sprintRate">0%</td>
                    </tr>
                </table>
            </div>
            
            <!-- Subject Breakdown (Student Mode Only) -->
            <div id="subjectBreakdownSection" class="stats-table hidden" style="margin-top: 2rem;">
                <h3 class="stats-title">üìö SUBJECT BREAKDOWN</h3>
                <div id="subjectBreakdown" class="subject-breakdown-content">
                    <!-- Populated by JavaScript -->
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; margin-top: 1rem;">
                    Based on completed tasks
                </p>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="app.html">üéØ Workspace</a>
        <span class="footer-separator">|</span>
        <a href="how-to.html">üìñ How-to</a>
        <span class="footer-separator">|</span>
        <a href="guide.html">üí¨ Support</a>
        <span class="footer-separator">|</span>
        <a href="app.html#feedback" style="color: var(--industrial-orange);">üéØ Beta Feedback</a>
    </footer>

    <!-- Mode Configuration System -->
    <script src="config.js"></script>
    
    <!-- Weekly Reports -->
    <script src="weekly-reports.js"></script>

    <script type="module">
        // Import Firebase
    <script>
        // ============================================
        // LOCALSTORAGE AUTHENTICATION CHECK
        // ============================================
        
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('focushub_current_user') || 'null');
        
        if (!currentUser) {
            // Not logged in, redirect to start page
            window.location.href = 'start.html';
        }
        
        // User is logged in, set up logout function
        window.handleFirebaseLogout = function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('focushub_current_user');
                window.location.href = 'start.html';
            }
        };
        
        console.log('‚úÖ User authenticated:', currentUser.email);
    </script>
    
        function initDashboard() {
            // Dashboard initialization continues below
        }
    </script>

    <script>
        // ============================================
        // AUTHENTICATION CHECK (LEGACY - FIREBASE ABOVE)
        // ============================================
        const currentUser = JSON.parse(localStorage.getItem('focushub_current_user') || 'null');
        
        if (!currentUser) {
            // Not logged in, redirect to auth
            window.location.href = 'start.html';
        }
        
        // ============================================
        // USER-SPECIFIC STORAGE HELPERS
        // ============================================
        function getUserKey(baseKey) {
            return currentUser ? `${baseKey}_${currentUser.id}` : baseKey;
        }
        
        function getUserItem(baseKey) {
            return localStorage.getItem(getUserKey(baseKey));
        }
        
        function setUserItem(baseKey, value) {
            localStorage.setItem(getUserKey(baseKey), value);
        }
        
        // Display current mode
        function displayCurrentMode() {
            const modeEl = document.getElementById('currentMode');
            if (modeEl && window.getModeDisplayName) {
                modeEl.textContent = getModeDisplayName().toUpperCase();
            }
            
            // Show admin link if user is admin
            const users = JSON.parse(localStorage.getItem('focushub_users') || '[]');
            const userFull = users.find(u => u.id === currentUser.id);
            if (userFull && userFull.plan === 'admin') {
                document.getElementById('adminLink').classList.remove('hidden');
            }
            
            // Show upgrade button if user is on free plan
            if (userFull && userFull.plan === 'free') {
                document.getElementById('upgradeBtn').classList.remove('hidden');
            }
            
            // Check for admin impersonation
            const adminReturn = sessionStorage.getItem('admin_return');
            if (adminReturn) {
                document.getElementById('impersonationBanner').classList.remove('hidden');
                document.getElementById('impersonatedEmail').textContent = currentUser.email;
            }
        }
        
        // Return to admin panel
        function returnToAdmin() {
            const adminReturn = sessionStorage.getItem('admin_return');
            if (!adminReturn) return;
            
            const adminUser = JSON.parse(adminReturn);
            
            // Restore admin session
            localStorage.setItem('focushub_current_user', JSON.stringify(adminUser));
            localStorage.setItem('focushub_mode', adminUser.mode);
            
            // Clear impersonation
            sessionStorage.removeItem('admin_return');
            
            // Return to admin panel
            window.location.href = 'settings.html';
        }
        
        // Update current time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toUTCString();
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Display mode on load
        displayCurrentMode();

        // Load stats from history
        function loadStats() {
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            
            if (history.length === 0) {
                // Show empty state
                const emptyState = document.getElementById('overviewEmptyState');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
            
            // Hide empty state if there's data
            const emptyState = document.getElementById('overviewEmptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            // Calculate total sprints
            const totalSprints = history.reduce((sum, day) => sum + day.sprintCount, 0);
            document.getElementById('totalSprints').textContent = totalSprints;
            document.getElementById('totalSprintsContext').textContent = totalSprints;

            // Calculate total tasks
            const totalTasks = history.reduce((sum, day) => sum + day.tasksCompleted, 0);
            document.getElementById('totalTasks').textContent = totalTasks;

            // Calculate streak (consecutive days with B+ or higher)
            const gradeThreshold = ['A+', 'A', 'A-', 'B+', 'B'];
            let streak = 0;
            for (let i = history.length - 1; i >= 0; i--) {
                const grade = history[i].userGrade || history[i].autoGrade;
                if (gradeThreshold.includes(grade)) {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('dayStreak').textContent = streak;

            // Calculate average grade
            const gradeValues = {
                'A+': 4.3, 'A': 4.0, 'A-': 3.7,
                'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                'C+': 2.3, 'C': 2.0, 'C-': 1.7,
                'D+': 1.3, 'D': 1.0, 'D-': 0.7,
                'F': 0.0
            };
            const avgGradeValue = history.reduce((sum, day) => {
                return sum + (gradeValues[day.userGrade || day.autoGrade] || 0);
            }, 0) / history.length;
            
            document.getElementById('avgGrade').textContent = avgGradeValue.toFixed(1);
            document.getElementById('focusScore').textContent = ((avgGradeValue / 4.3) * 100).toFixed(0) + '%';

            // Days logged
            document.getElementById('daysLogged').textContent = history.length;

            // Average distractions
            const avgDistractions = (history.reduce((sum, day) => sum + day.distractionCount, 0) / history.length).toFixed(1);
            document.getElementById('avgDistractions').textContent = avgDistractions;

            // Sprint completion rate
            const sprintRate = history.reduce((sum, day) => {
                return sum + Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
            }, 0) / history.length;
            document.getElementById('sprintRate').textContent = sprintRate.toFixed(0) + '%';

            // Weekly chart (last 7 days)
            const last7 = history.slice(-7);
            const chartHTML = last7.map(day => {
                const percentage = Math.min((day.sprintCount / day.plannedSprints) * 100, 100);
                // Muted gray default, brand orange for 100%+ completion
                const color = percentage >= 100 ? '#f45b07' : '#6b7280';
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                return `
                    <div class="bar-mini">
                        <div class="bar-fill" style="height: ${percentage}%; background: ${color}"></div>
                        <div class="bar-day">${dayName}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('weeklyChart').innerHTML = chartHTML;

            // Intention vs Reality
            const intentions = JSON.parse(getUserItem('focushub_intentions') || '[]');
            const intentionCount = intentions.length;
            const followedThrough = intentions.filter(i => i.completed).length;
            
            document.getElementById('intentionCount').textContent = intentionCount;
            document.getElementById('realityCount').textContent = followedThrough;
            
            if (intentionCount > 0) {
                const intentionPercent = 100;
                const realityPercent = (followedThrough / intentionCount) * 100;
                document.getElementById('intentionFill').style.width = intentionPercent + '%';
                document.getElementById('realityFill').style.width = realityPercent + '%';
            }
            
            // Subject breakdown (student mode only)
            loadSubjectBreakdown();
        }
        
        // Calculate and display subject breakdown
        function loadSubjectBreakdown() {
            const config = window.loadModeConfig ? loadModeConfig() : null;
            const subjectSection = document.getElementById('subjectBreakdownSection');
            
            // Only show for student mode
            if (!config || !config.features || !config.features.subjects) {
                if (subjectSection) {
                    subjectSection.classList.add('hidden');
                }
                return;
            }
            
            // Show section
            if (subjectSection) {
                subjectSection.classList.remove('hidden');
            }
            
            // Get completed tasks from history
            const history = JSON.parse(getUserItem('focushub_history') || '[]');
            const subjectSprints = {};
            
            // Calculate sprints per subject from all history
            history.forEach(day => {
                if (day.wins && Array.isArray(day.wins)) {
                    day.wins.forEach(task => {
                        if (task.subject) {
                            subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                        }
                    });
                }
            });
            
            // Also check current tasks
            const currentTasks = JSON.parse(getUserItem('focushub_tasks') || '{"wins":[]}');
            if (currentTasks.wins && Array.isArray(currentTasks.wins)) {
                currentTasks.wins.forEach(task => {
                    if (task.subject) {
                        subjectSprints[task.subject] = (subjectSprints[task.subject] || 0) + (task.sprints || 0);
                    }
                });
            }
            
            // Render subject breakdown
            const breakdownEl = document.getElementById('subjectBreakdown');
            if (!breakdownEl) return;
            
            if (Object.keys(subjectSprints).length === 0) {
                breakdownEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No subjects tracked yet. Complete tasks with subjects to see breakdown.</p>';
                return;
            }
            
            const totalSprints = Object.values(subjectSprints).reduce((a, b) => a + b, 0);
            
            const html = Object.entries(subjectSprints)
                .sort((a, b) => b[1] - a[1]) // Sort by sprints descending
                .map(([subject, sprints]) => {
                    const percentage = ((sprints / totalSprints) * 100).toFixed(0);
                    return `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; color: var(--text-primary);">${subject}</span>
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">${sprints} sprints (${percentage}%)</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: var(--primary-color);"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            breakdownEl.innerHTML = html;
        }

        // Theme detection and logo swap
        function initTheme() {
            const theme = localStorage.getItem('focushub_theme') || 'dark';
            const dashboardLogo = document.getElementById('dashboardLogo');
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                dashboardLogo.src = 'FocusHub_vertdark.svg';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                dashboardLogo.src = 'FocusHub_vertnorm.svg';
            }
        }

        // Check session state and update button
        function checkSessionState() {
            const sessionState = getUserItem('focushub_session_state');
            const dailyStats = getUserItem('focushub_daily_stats');
            const button = document.querySelector('.primary-action');
            
            // If session is active (not ended and has data)
            if (sessionState !== 'ended' && dailyStats) {
                const stats = JSON.parse(dailyStats);
                const today = new Date().toDateString();
                
                // Check if stats are from today
                if (stats.date === today) {
                    button.innerHTML = `
                        <span class="action-icon">[ &gt; ]</span>
                        <span class="action-text">RETURN TO WORKSPACE</span>
                    `;
                }
            }
        }

        // Update dashboard timer display
        function updateDashboardTimer() {
            const savedTimer = getUserItem('focushub_timer');
            if (!savedTimer) {
                document.getElementById('dashboardTimer').classList.add('hidden');
                return;
            }
            
            const timerData = JSON.parse(savedTimer);
            
            if (timerData.isRunning && timerData.timeLeft > 0) {
                // Calculate current time left
                const elapsed = Math.floor((Date.now() - timerData.lastUpdated) / 1000);
                const timeLeft = Math.max(0, timerData.timeLeft - elapsed);
                
                if (timeLeft > 0) {
                    const mins = Math.floor(timeLeft / 60);
                    const secs = timeLeft % 60;
                    document.getElementById('dashboardTimerText').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    document.getElementById('dashboardTimer').classList.remove('hidden');
                    
                    // Update every second
                    setTimeout(updateDashboardTimer, 1000);
                } else {
                    document.getElementById('dashboardTimer').classList.add('hidden');
                }
            } else {
                document.getElementById('dashboardTimer').classList.add('hidden');
            }
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (window.handleFirebaseLogout) {
                window.handleFirebaseLogout();
            }
        });

        initTheme();
        checkSessionState();
        updateDashboardTimer();
        loadStats();
    </script>

    <!-- Floating AI Support Button -->
    <button id="aiSupportToggle" style="position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; background: var(--industrial-orange); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" aria-label="Open support chat">
        üí¨
    </button>

    <!-- AI Support Panel (hidden by default) -->
    <div id="aiSupportPanel" style="display: none; position: fixed; bottom: 5rem; right: 2rem; width: 360px; max-height: 500px; background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); z-index: 1000; overflow: hidden;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-light);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">FocusHub Support</h3>
                <button id="closeAiPanel" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; padding: 0;">√ó</button>
            </div>
        </div>
        
        <div id="aiChatMessages" style="height: 320px; overflow-y: auto; padding: 1rem; background: var(--bg-primary);">
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 1rem;">
                <p style="font-size: 14px; color: var(--text-primary); margin: 0;">Ask questions about how FocusHub works, its features, or troubleshooting.</p>
            </div>
        </div>

        <div style="padding: 1rem; border-top: 1px solid var(--border-light);">
            <div style="display: flex; gap: 0.5rem;">
                <input 
                    type="text" 
                    id="aiChatInput" 
                    placeholder="Type your question..."
                    style="flex: 1; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-medium); color: var(--text-primary); font-size: 14px; border-radius: 4px;"
                >
                <button id="aiSendMessage" style="background: var(--industrial-orange); color: white; padding: 0.75rem 1rem; border: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 4px;">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        // AI Support Panel Toggle
        const aiToggle = document.getElementById('aiSupportToggle');
        const aiPanel = document.getElementById('aiSupportPanel');
        const aiClose = document.getElementById('closeAiPanel');

        if (aiToggle && aiPanel && aiClose) {
            aiToggle.addEventListener('click', () => {
                const isVisible = aiPanel.style.display !== 'none';
                aiPanel.style.display = isVisible ? 'none' : 'block';
            });

            aiClose.addEventListener('click', () => {
                aiPanel.style.display = 'none';
            });

            // Chat functionality
            const sendBtn = document.getElementById('aiSendMessage');
            const chatInput = document.getElementById('aiChatInput');
            const chatMessages = document.getElementById('aiChatMessages');

            if (sendBtn && chatInput && chatMessages) {
                sendBtn.addEventListener('click', sendAiMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendAiMessage();
                });

                function sendAiMessage() {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    // Add user message
                    const userMsg = document.createElement('div');
                    userMsg.style.cssText = 'background: var(--industrial-orange); color: white; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; margin-left: 2rem; font-size: 14px;';
                    userMsg.textContent = message;
                    chatMessages.appendChild(userMsg);

                    chatInput.value = '';

                    // Intelligent response based on keywords
                    const msgLower = message.toLowerCase();
                    let response = 'Check the How-To guide or FAQ for detailed guidance.';
                    
                    // Privacy-related responses
                    if (msgLower.includes('privacy') || msgLower.includes('data') || msgLower.includes('personal information')) {
                        response = 'üîí Your privacy is our priority! Task text is automatically deleted every Friday. View our Privacy Policy for details, or export/delete your data anytime from the footer.';
                    } else if (msgLower.includes('delete') && (msgLower.includes('account') || msgLower.includes('data'))) {
                        response = 'üóëÔ∏è To delete your account and all data: scroll to the footer and click "Delete My Account". This action is permanent and immediate.';
                    } else if (msgLower.includes('export') || msgLower.includes('download')) {
                        response = 'üì• To export all your data: scroll to the footer and click "Export My Data". You\'ll get a JSON file with everything.';
                    } else if (msgLower.includes('gdpr') || msgLower.includes('ccpa') || msgLower.includes('compliance')) {
                        response = '‚úÖ FocusHub is GDPR and CCPA compliant. We automatically delete task text weekly, never sell data, and give you complete control. See Privacy Policy for details.';
                    } else if (msgLower.includes('weekly') || msgLower.includes('friday') || msgLower.includes('deletion')) {
                        response = 'üìÖ Every Friday at 11:59 PM, we automatically delete all task text and personal information. We keep only anonymized statistics for 90 days to show trends.';
                    } else if (msgLower.includes('backup') || msgLower.includes('save')) {
                        response = 'üíæ Your data is automatically backed up! We keep rolling 7-day backups (encrypted), plus cloud sync if enabled. You can also export your data anytime.';
                    } else if (msgLower.includes('sync') || msgLower.includes('cloud')) {
                        response = '‚òÅÔ∏è Cloud sync is optional and encrypted. Your data is stored locally first, then optionally synced to secure Supabase servers. You can use FocusHub completely offline.';
                    } else if (msgLower.includes('secure') || msgLower.includes('encryption') || msgLower.includes('safe')) {
                        response = 'üîê Your data is encrypted in transit (TLS 1.3) and at rest (AES-256). We use Supabase (SOC 2 certified) for cloud storage. Local data stays on your device.';
                    }

                    // Simulate agent response
                    setTimeout(() => {
                        const agentMsg = document.createElement('div');
                        agentMsg.style.cssText = 'background: var(--bg-secondary); color: var(--text-primary); padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; margin-right: 2rem; font-size: 14px; line-height: 1.5;';
                        agentMsg.innerHTML = response;
                        chatMessages.appendChild(agentMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1000);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        }
    </script>

    <!-- Privacy & Data Management Footer -->
    <footer style="
        margin-top: 4rem;
        padding: 2rem;
        border-top: 1px solid var(--border-light);
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
    ">
        <div style="margin-bottom: 1rem;">
            <a href="/privacy.html" style="color: var(--primary-color); margin: 0 1rem;">Privacy Policy</a>
            <span style="color: var(--border-light);">|</span>
            <a href="/faq.html" style="color: var(--primary-color); margin: 0 1rem;">FAQ</a>
            <span style="color: var(--border-light);">|</span>
            <a href="/how-to.html" style="color: var(--primary-color); margin: 0 1rem;">How-To Guide</a>
        </div>
        <p style="margin: 0.5rem 0;">
            üîí Your tasks are automatically deleted every Friday<br>
            Data stored locally & optionally synced (encrypted)
        </p>
        <p style="margin: 0.5rem 0; font-size: 0.75rem;">
            &copy; 2026 FocusHub. Built for privacy.
        </p>
    </footer>
</body>
</html>
